<apex:page standardController="cscfga__Product_Definition__c" extensions="cspduia.ProductDesignerController" id="fullPage" showHeader="true" sidebar="true" standardStylesheets="true">
    <apex:form id="fullform">
		    <apex:includeScript value="{!$Resource.cspduia__jQuery}" />
		    <apex:includeScript value="{!$Resource.cspduia__jQueryMigrate}" /> 
		    <apex:includeScript value="{!$Resource.cspduia__JQueryUI}" />
		    <apex:includeScript value="{!$Resource.cspduia__eventDropJquery2}" />
		    <apex:includeScript value="{!$Resource.cspduia__eventDropJqueryLive2}" />
		    <apex:includeScript value="{!$Resource.cspduia__eventDragJquery2}" />
		    <apex:includeScript value="{!$Resource.cspduia__eventDragJqueryLive2}" />
		    <apex:includeScript value="{!$Resource.cspduia__OverlayJs}"/>
		    <apex:includeScript value="{!$Resource.cspduia__jQueryDDSlick}"/>
		    <apex:includeScript value="{!$Resource.cspduia__jQueryBlockUI}"/>
		    <apex:includeScript value="{!$Resource.cspduia__jQueryjGrowlJS}"/>
		    <apex:includeScript value="{!$Resource.cspduia__jQueryMultiSelectJs}" />
		    <apex:includeScript value="{!$Resource.cspduia__jQueryKeyTable}" />
		    <apex:includeScript value="{!$Resource.cspduia__JQueryJeditable}" />
		    <apex:includeScript value="{!$Resource.cspduia__jQueryTableDnD}" />
		    <apex:stylesheet value="{!$Resource.cspduia__jQueryMultiSelectCss}"/>
		    <apex:stylesheet value="{!$Resource.cspduia__jQueryjGrowlCSS}"/>
		    <apex:stylesheet value="{!$Resource.cspduia__OverlayCss}"/>
		    <apex:stylesheet value="{!$Resource.cspduia__JQueryKeyTableCSS}"/>
		
		    <style type="text/css">
		        ol {
		            float: left;
		            margin: 0 40px 0 0;
		            padding: 0;
		        }
		        .draggableCell {
		            border: 1px solid #89B;
		            background: #BCE;
		            padding: 2px 5px;
		            margin: 2px 0;
		            cursor: move;
		            display:table-column;
		            cursor: move;
		            float:left;
		            /*fix for  buggy browsers*/
		        }
		        .singleCellSizeSpacer {
		            background: #DDE;
		            //opacity: 0.1;
		            width: 275px;
		            line-width: 275px;
		            height: 16px;
		        }
		        .singleCellSize {
		            width: 275px;
		            line-width: 275px;
		            height: 16px;
		        }
		        .doubleCellSize {
		            width: 562px;
		            line-width: 562px;
		            height: 16px;
		        }
		        .dragging {
		            background-color: #BEE;
		            border-color: #8BB;
		        }
		        .hierarchy-image {
		            display: block;
		            float:left;
		            position:relative;
		            top:0px;
		            margin: 2px;
		            right: 0px;
		            cursor: pointer;
		            width:12px;
		            height:12px;
		            z-index:10;
		        }
		        .setup-image {
		            display: block;
		            float:right;
		            position:relative;
		            top:0px;
		            margin: 2px;
		            right: -4px;
		            cursor: pointer;
		            width:12px;
		            height:12px;
		            z-index:10;
		        }
		        .action-image {
		            display: block;
		            float:right;
		            position:relative;
		            top:0px;
		            margin: 2px;
		            right: 0px;
		            cursor: pointer;
		            width:12px;
		            height:12px;
		            z-index:10;
		        }
		        .delete-image {
		            display: block;
		            float:right;
		            position:relative;
		            top:0px;
		            margin: 2px;
		            right: -4px;
		            cursor: pointer;
		            width:12px;
		            height:12px;
		            z-index:10;
		        }
		        .screen-image {
		            display: block;
		            float:right;
		            position:relative;
		            top:0px;
		            margin: 2px;
		            right: 0px;
		            cursor: pointer;
		            width:12px;
		            height:12px;
		            z-index:10;
		        }
		        .section-image {
		            margin: 2px;
		            cursor: pointer;
		            width:12px;
		            height:12px;
		            z-index:10;
		        }
		        .remove-image {
		            display: block;
		            float:right;
		            position:relative;
		            top:0px;
		            margin: 2px;
		            right: -4px;
		            cursor: pointer;
		            width:12px;
		            height:12px;
		            z-index:10;
		        }
		        .toggle-image {
		            display: block;
		            float:right;
		            position:relative;
		            top:0px;
		            margin: 2px;
		            right: -4px;
		            cursor: pointer;
		            width:12px;
		            height:12px;
		            z-index:10;
		        }
		        .label-image {
		            cursor: pointer;
		            margin-right: 5px;
		        }
		        .blank-image {
		            display: block;
		            float:right;
		            position:relative;
		            top:0px;
		            right: -4px;
		            height: 20px;
		        }
		        .div-table {
		            display:table;
		            background-color:#eee;
		            border:1px solid #666666;
		            border-spacing:5px;
		            /*cellspacing:poor IE support for  this*/
		        }
		        .div-block {
		            display:block;
		            background-color:#eee;
		            border:1px solid #666666;
		            border-spacing:5px;
		            overflow-y: scroll;
		            max-height: 100px;
		            /*cellspacing:poor IE support for  this*/
		        }
		        .singleColumnTableSize {
		            width: 310px;
		            line-width: 300px;
		            min-height: 500px;
		        }
		        .doubleColumnTableSize {
		            width: 590px;
		            line-width: 570px;
		            min-height: 100px;
		        }
		        
		        .right
		        {
		            position:relative;
		            right:0px;
		        }
		        .handle {
		        	cursor: move;
		        }
		        //
		        ul.Screen-Select-Sort { list-style-type: none; margin: 0; padding: 0; width: 60%; }
				ul.Screen-Select-Sort li.screen-sort-li { margin: 0 3px 3px 3px; padding: 0.4em; padding-left: 1.5em; font-size: 1.2em; height: 16px; }
				ul.Screen-Select-Sort li.screen-sort-li {
					border: 1px solid #d3d3d3;
					background: #BCE url({!URLFOR($Resource.ProductDefinitionBuilderIcons, 'screen-24.png')}) 1% 50% no-repeat;
					background-size: 15px 15px; 
					font-weight: normal;
					color: #555555;
					min-width: 235px;
					height: 20px;
					list-style: none;
				}
		        ul.Section-Select-Sort { list-style-type: none; margin: 0; padding: 0; width: 60%;}
				ul.Section-Select-Sort li { margin: 0 3px 3px 3px; padding: 0px; padding-left: 2.0em; font-size: 1.1em; height: 14px; }
				ul.Section-Select-Sort li {
					border: 1px solid #d3d3d3;
					background: #DDE url({!URLFOR($Resource.ProductDefinitionBuilderIcons, 'section-20.png')}) 1% 50% no-repeat;
					background-size: 15px 15px; 
					font-weight: normal;
					color: #555555;
					min-width: 220px;
					height: 20px;
					list-style: none;
				}
		        //
		        ul.CalcAttribute-Select-Sort { list-style-type: none; margin: 0; padding: 0; width: 60%; }
				ul.CalcAttribute-Select-Sort li.CalcAttribute-sort-li { margin: 0 3px 3px 3px; padding: 0.4em; padding-left: 1.5em; font-size: 1.2em; height: 16px; }
				ul.CalcAttribute-Select-Sort li.CalcAttribute-sort-li {
					border: 1px solid #d3d3d3;
					background: #BCE url({!URLFOR($Resource.ProductDefinitionBuilderIcons, 'calculation-20.png')}) 1% 50% no-repeat;
					background-size: 15px 15px; 
					font-weight: normal;
					color: #555555;
					min-width: 235px;
					height: 20px;
					list-style: none;
				}
				//
				ul.single-col-rule-div { list-style-type: none; margin: 0; padding: 0; width: 60%; }
				ul.single-col-rule-div li.rule-li { margin: 3px 0px 0px 3px; padding: 2px 5px; height: 16px; }
				ul.single-col-rule-div li.rule-li {
		            border: 1px solid #89B;
		            background: #BCE;
		            display:none;
		            cursor: move;
		            width: 250px;
		            font-size: 12px;
					//padding: 0;
					margin-left: 0;
				}
				ul.rule-div { list-style-type: none; margin: 0; padding: 0; width: 60%; float:left; height: 30px;}
				ul.rule-div li.rule-li { margin: 3px 0px 0px 3px; padding: 2px 5px; height: 16px; }
				ul.rule-div li.rule-li {
		            border: 1px solid #89B;
		            background: #BCE;
		            display:table-column;
		            //cursor: move;
		            float:left;
		            width: 558px;
		            font-size: 12px;
				}
				ul.predicate-div { list-style-type: none; margin: 0; padding: 0; width: 60%; float:left; height: 30px;}
				ul.predicate-div li.rule-li { margin: 3px 0px 0px 3px; padding: 2px 5px; height: 16px; }
				ul.predicate-div li.rule-li {
		            border: 1px solid #89B;
		            background: #BCE;
		            display:table-column;
		            //cursor: move;
		            float:left;
		            width: 558px;
		            font-size: 12px;
				}
				ul.action-normal-div { list-style-type: none; margin: 0; padding: 0; width: 60%; float:left; height: 30px;}
				ul.action-normal-div li.rule-li { margin: 3px 0px 0px 3px; padding: 2px 5px; height: 16px; }
				ul.action-normal-div li.rule-li {
		            border: 1px solid #89B;
		            background: #BCE;
		            display:table-column;
		            //cursor: move;
		            float:left;
		            width: 558px;
		            font-size: 12px;
				}
				ul.action-else-div { list-style-type: none; margin: 0; padding: 0; width: 60%; float:left; height: 30px;}
				ul.action-else-div li.rule-li { margin: 3px 0px 0px 3px; padding: 2px 5px; height: 16px; }
				ul.action-else-div li.rule-li {
		            border: 1px solid #89B;
		            background: #BCE;
		            display:table-column;
		            //cursor: move;
		            float:left;
		            width: 558px;
		            font-size: 12px;
				}
				.placeholder {
		            border: 1px solid #89B;
		            background: #DDE;
		            display:table-column;
		            cursor: move;
		            float:left;
		            width: 558px;
		            font-size: 12px;
		            margin: 3px 0px 0px 3px; 
		            padding: 2px 5px;
		            height: 16px;
			    }
				.placeholder-rules-component {
		            border: 1px solid #89B;
		            background: #DDE;
		            display:table-column;
		            cursor: move;
		            float:left;
		            width: 250px;
		            font-size: 12px;
		            margin: 3px 0px 0px 3px; 
		            padding: 2px 5px;
		            height: 16px;
			    }
			    .attribute-rule-components {
			    	list-style-type: none;
					padding: 0;
					margin: 0;
					overflow: auto;
			    }
			    .product-rule-components {
			    	list-style-type: none;
					padding: 0;
					margin: 0;
					overflow: auto;
			    }
			    .rule-components {
			    	list-style-type: none;
					padding: 0;
					margin: 0;
					overflow: auto;
			    }
			    .required {
			    	min-width: 3px;
					width: 3px;
					background: red;
					float: left;
					min-height: 22px;
					position: relative;
					left: -6px;
					top: -3px;
			    }
			    table.growl {margin: 0; padding: 0; width: 100%;}
				table.growl tr td { color: #ffffff; margin: 3px 0px 0px 3px; padding: 2px 5px;}
				table.growl tr td img { width: 20px; height: 20px; }
				
				// ----------------------------------------------
				// Predictive text
				
				.ui-helper-hidden-accessible { display:none; }
				.ui-front {
					z-index: 100;
				}
						
				.ui-autocomplete {
					position: absolute;
					top: 0;
					left: 0;
					cursor: default;
					max-height: 200px;
					overflow-y: auto;
					/* prevent horizontal scrollbar */
					overflow-x: hidden;
				}
						
				.ui-menu {
					list-style: none;
					padding: 2px;
					margin: 0;
					display: block;
					outline: none;
				}
				.ui-menu .ui-menu {
					margin-top: -3px;
					position: absolute;
				}
				.ui-menu .ui-menu-item {
					margin: 0;
					padding: 0;
					width: 100%;
					/* support: IE10, see #8844 */
					list-style-image: url(data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7);
				}
				.ui-menu .ui-menu-divider {
					margin: 5px -2px 5px -2px;
					height: 0;
					font-size: 0;
					line-height: 0;
					border-width: 1px 0 0 0;
				}
				.ui-menu .ui-menu-item a {
					text-decoration: none;
					display: block;
					padding: 2px .4em;
					line-height: 1.5;
					min-height: 0; /* support: IE7 */
					font-weight: normal;
				}
				.ui-menu .ui-menu-item a:hover { 
				        	background:#ddd; 
				        	color:#000;
				        }
				
				.ui-menu .ui-menu-item a.ui-state-focus,
				.ui-menu .ui-menu-item a.ui-state-active {
					font-weight: normal;
					margin: -1px;
				        	background:#ddd; 
				}
				
				.ui-menu .ui-state-disabled {
					font-weight: normal;
					margin: .4em 0 .2em;
					line-height: 1.5;
				}
				.ui-menu .ui-state-disabled a {
					cursor: default;
				}
				.ui-widget {
					font-family: Verdana,Arial,sans-serif;
					font-size: 1.1em;
				}
				.ui-widget .ui-widget {
					font-size: 1em;
				}
				.ui-widget input,
				.ui-widget select,
				.ui-widget textarea,
				.ui-widget button {
					font-family: Verdana,Arial,sans-serif;
					font-size: 1em;
				}
				.ui-widget-content {
					border: 1px solid #aaaaaa;
					background: #ffffff url(images/ui-bg_flat_75_ffffff_40x100.png) 50% 50% repeat-x;
					color: #222222;
				}
				.ui-widget-content a {
					color: #222222;
				}
				.ui-widget-header {
					border: 1px solid #aaaaaa;
					background: #cccccc url(images/ui-bg_highlight-soft_75_cccccc_1x100.png) 50% 50% repeat-x;
					color: #222222;
					font-weight: bold;
				}
				.ui-widget-header a {
					color: #222222;
				}
				.ui-autocomplete-category {
				    font-weight: bold;
				    padding: .2em .4em;
				    margin: .8em 0 .2em;
				    line-height: 1.5;
				}
				.action-options { 
					border:solid 1px #ccc; 
					border-top:none; 
					list-style:none; 
					box-shadow:0px 1px 5px #ddd; 
					display:none; 
					position:absolute;
					top: 0px; 
					z-index:2000; 
					margin:0; 
					padding:0;
					background:#fff; 
					overflow:auto;
					margin-left: 0px;
					width: 495px;
				}
		        .action-option { 
		        	width:225px;
		        	padding:10px; 
		        	display:inline-block; 
		        	border-bottom:solid 1px #ddd; 
		        	overflow:hidden; 
		        	text-decoration:none; 
		        	color:#333; 
		        	cursor:pointer;
		        	-webkit-transition: all 0.25s ease-in-out; 
		        	-moz-transition: all 0.25s ease-in-out;
		        	-o-transition: all 0.25s ease-in-out;
		        	-ms-transition: all 0.25s ease-in-out; 
					margin-left: 0px;
					height: 20px;
		        }
		        .action-options > li:last-child > .dd-option { 
		        	border-bottom:none;
		        }
		        .action-option:hover { 
		        	background:#f3f3f3; 
		        	color:#000;
		        }
		        .action-item-image {
		            display: block;
		            float: left;
		            position:relative;
		            top:0px;
		            margin: 2px;
		            right: 4px;
		            cursor: pointer;
		            width:12px;
		            height:12px;
		            z-index:10;
		        }
				// ------------------------------------------------------
				//
                .ms-container {
		  			background: transparent url('{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'switch.png')}') no-repeat 110px 80px;
				}
				.custom-header {
					background: #4589B9;
					color: #ffffff;
					font-weight: bold;
					font-size: 10px;
				}
				.ms-container ul.ms-list{
				  width: 100px;
				  height: 200px;
				  padding: 0;
				  overflow-y: auto;
				}
		    </style>
		    <script type="text/javascript">
				var selectedScreenId = '';
				var sortSaveEvent = false;
				var deleteScreenEvent = false;
				var selectedMasterRelationshipId = '';
				var createdRuleId = '';
				//
				var keys = null;
		    	//
		    	$('document').ready(function () {
		    		initialisePage();
		    	});
		    	//
		    	$(document).scroll(function() {
				    if ($(this).scrollTop() > 0) {
				        //console.log($(this).scrollTop());
				        $('#top-left-column').css('position','fixed');
				        $('#top-left-column').css('z-index','100');
				        $('#top-right-column').css('position','fixed');
				        $('#top-right-column').css('z-index','100');
				        $('#top-centre-column').css('padding-left','240px');
				        $('#header-top-centre-column').css('padding-left','240px');
				    } else {
				        $('#top-left-column').css('position','relative');
				        $('#top-right-column').css('position','relative');
				        $('#top-centre-column').css('padding-left','0px');
				        $('#header-top-centre-column').css('padding-left','0px');
				    }
				});
		    	//
				function getExpressionOptions() {
					Visualforce.remoting.Manager.invokeAction(
						'{!$RemoteAction.ProductDesignerController.getExpressionOptions}',
						'{!cscfga__Product_Definition__c}',
						handleGetExpressionOptionsResponse,
						{escape: false}
					);
				}
				
				function handleGetExpressionOptionsResponse(result, event) {
					if (event.type == 'exception') {
						growlNow(event.message);
					} else {
						console.log('____Refreshing expression options.___');
						console.log('*****:'+result);
						expressionOptions = result;
						/*
						console.log('**result: '+result);
						for(var i = 0; i < result.length; i++) {
							console.log('**result: '+result.["label"]+' - '+result.["category"]);
						}
						*/
					}
				}
		    	//
				function getAttributeDetails(attributeId) {
					Visualforce.remoting.Manager.invokeAction(
						'{!$RemoteAction.ProductDesignerController.loadAttributeDetails}',
						attributeId,
						handleGetAttributeDetailsResponse,
						{escape: false}
					);
				}
				//
				function handleGetAttributeDetailsResponse(result, event) {
					if (event.type == 'exception') {
						growlNow(event.message);
					} else {
						var attribute = result;
						blockScreenElement('.propertyInspector');
						// Display the relevant property Inspector: 
						$('.property-inspector').hide();
						var currentPropertyInspector = '#attributePropertyInspector-'+attribute.cscfga__Type__c.split(' ').join('');
						$('#attributePropertyInspector-'+attribute.cscfga__Type__c.split(' ').join('')).show();
						//console.log(attribute.Name+' - '+attribute.cscfga__Type__c);
						// set attributeId
						$(currentPropertyInspector+' > table').find('.attribute-id').val(attribute.Id);
						$(currentPropertyInspector+' > table').find('.field-label').each(function () {
							var fieldLabel = $.trim($(this).text());
							////console.log(fieldLabel+':'+$(this).next().find('input').attr('Id')+'-:-'+attribute.cscfga__Label__c);
							if (fieldLabel == 'Name') $(this).next().find('input').val(attribute.Name);
							if (fieldLabel == 'Label') $(this).next().find('textarea').val(attribute.cscfga__Label__c);
							if (fieldLabel == 'Lookup Config') {
								var lookupFieldDescInputId = $(this).next().find('.lookupInput').find('input').attr('Id'); 
								// //console.log('---->'+lookupFieldDescInputId +':'+attribute.cscfga__Lookup_Config__r.Name+':'+attribute.cscfga__Lookup_Config__c);
								$('#'+escapeId(lookupFieldDescInputId)).val((attribute.cscfga__Lookup_Config__r == undefined ? '':attribute.cscfga__Lookup_Config__r.Name));
								$('#'+escapeId(lookupFieldDescInputId)+'_lkid').val(attribute.cscfga__Lookup_Config__c);
							}
							if (fieldLabel == 'Type') $(this).next().find('select').val(attribute.cscfga__Type__c);
							if (fieldLabel == 'Required') {
								if (attribute.cscfga__Required__c) {
									$(this).next().find('input').prop('checked',true);
								} else {
									$(this).next().find('input').prop('checked',false);
								}
							}
							if (fieldLabel == 'Data Type') $(this).next().find('select').val(attribute.cscfga__Data_Type__c);
							if (fieldLabel == 'Default Value') $(this).next().find('textarea').val(attribute.cscfga__Default_Value__c);
							if (fieldLabel == 'Is Line Item') {
								if (attribute.cscfga__Is_Line_Item__c) {
									$(this).next().find('input').prop('checked',true);
								} else {
									$(this).next().find('input').prop('checked',false);
								}
							}
							if (fieldLabel == 'Line Item Description') $(this).next().find('input').val(attribute.cscfga__Line_Item_Description__c);
							if (fieldLabel == 'Line Item Sequence') $(this).next().find('input').val(attribute.cscfga__Line_Item_Sequence__c);
							if (fieldLabel == 'Recurring') {
								if (attribute.cscfga__Recurring__c) {
									$(this).next().find('input').prop('checked',true);
								} else {
									$(this).next().find('input').prop('checked',false);
								}
							}
							if (fieldLabel == 'Enable Predictive Search') {
								if (attribute.cscfga__Enable_Predictive_Search__c) {
									$(this).next().find('input').prop('checked',true);
								} else {
									$(this).next().find('input').prop('checked',false);
								}
							}
							if (fieldLabel == 'Enable Null Option') {
								if (attribute.cscfga__Enable_null_option__c) {
									$(this).next().find('input').prop('checked',true);
								} else {
									$(this).next().find('input').prop('checked',false);
								}
							}
							if (fieldLabel == 'Enable Multiple Selection') {
								if (attribute.cscfga__Enable_Multiple_Selection__c) {
									$(this).next().find('input').prop('checked',true);
								} else {
									$(this).next().find('input').prop('checked',false);
								}
							}
							if (fieldLabel == 'Select List Lookup') {
								if (attribute.cscfga__Select_List_Lookup__c) {
									$(this).next().find('input').prop('checked',true);
								} else {
									$(this).next().find('input').prop('checked',false);
								}
							}
							if (fieldLabel == 'Is Rate Line Item') {
								if (attribute.cscfga__Is_Rate_Line_Item__c) {
									$(this).next().find('input').prop('checked',true);
								} else {
									$(this).next().find('input').prop('checked',false);
								}
							}
							if (fieldLabel == 'Desynchronises Bundle') {
								if (attribute.cscfga__is_significant__c) {
									$(this).next().find('input').prop('checked',true);
								} else {
									$(this).next().find('input').prop('checked',false);
								}
							}
							if (fieldLabel == 'Reference Value') $(this).next().find('input').val(attribute.cscfga__Reference_Value__c);
							if (fieldLabel == 'Minimum Input Length') $(this).next().find('input').val(attribute.cscfga__Minimum_Input_Length__c);
							if (fieldLabel == 'Column Size CSV') $(this).next().find('input').val(attribute.cscfga__Column_Size_CSV__c);
							if (fieldLabel == 'Scale') $(this).next().find('input').val(attribute.cscfga__Scale__c);
							if (fieldLabel == 'Text input lines') $(this).next().find('input').val(attribute.cscfga__Text_input_lines__c);
							if (fieldLabel == 'Hidden') {
								if (attribute.cscfga__Hidden__c) {
									$(this).next().find('input').prop('checked',true);
								} else {
									$(this).next().find('input').prop('checked',false);
								}
							}
							if (fieldLabel == 'Calculation Sequence') $(this).next().find('input').val(attribute.cscfga__Calculation_Sequence__c);
							if (fieldLabel == 'Max') $(this).next().find('input').val(attribute.cscfga__Max__c);
							if (fieldLabel == 'Min') $(this).next().find('input').val(attribute.cscfga__Min__c);
							if (fieldLabel == 'Custom Validation Pattern') $(this).next().find('input').val(attribute.cscfga__Pattern__c);
							if (fieldLabel == 'Custom Validation Error Message') $(this).next().find('input').val(attribute.cscfga__Custom_Validation_Error_Message__c);
							
							if (fieldLabel == 'Base Price') $(this).next().find('input').val(attribute.cscfga__Base_Price__c);
							if (fieldLabel == 'List Columns') $(this).next().find('input').val(attribute.cscfga__List_Columns__c);
							if (fieldLabel == 'Output Mapping') $(this).next().find('input').val(attribute.cscfga__Output_Mapping__c);
							if (fieldLabel == 'Cascade value') {
								if (attribute.cscfga__Cascade_value__c) {
									$(this).next().find('input').prop('checked',true);
								} else {
									$(this).next().find('input').prop('checked',false);
								}
							}
						});
						// Check if there are any select options to display
						if (attribute.cscfga__Type__c == 'Select List' || attribute.cscfga__Type__c == 'Radio Button') {
							keys = null;
							var table = '<table width="100%" class="display KeyTable" id="'+attribute.cscfga__Type__c.split(' ').join('')+'-selectOptions">';
							table += '<thead><tr><th style="vertical-align: middle;"><img src="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'add-12.png')}" title="Add Select Option" style="height: 9px;" onClick="addTableRow(\'selectOptions\',\''+attribute.cscfga__Type__c.split(' ').join('')+'\');"/></th><th>Display</th><th>Value</th><th>Price</th></tr></thead>';
							table += '<tbody>';
						}
						if (attribute.cscfga__Select_Options__r != undefined) {
							for (i = 0; i < attribute.cscfga__Select_Options__r.length; i++) {
								var opt = attribute.cscfga__Select_Options__r[i];
								 table += '<tr id="'+opt.Id+'">';
								 table += '<td style="vertical-align: middle;"><img src="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'delete-12.png')}" title="Delete Select Option" style="height: 9px;" onClick="$(this).parent().parent().remove();"/></td>';
								 table += '<td>'+opt["Name"]+'</td>';
								 table += '<td>'+opt["cscfga__Value__c"]+'</td>';
								 table += '<td>'+(opt["cscfga__Price__c"] == undefined ? '' : opt["cscfga__Price__c"])+'</td>';
								 table += '</tr>';
							}
						}
						if (attribute.cscfga__Type__c == 'Select List' || attribute.cscfga__Type__c == 'Radio Button') {
							table += '</tbody>';
							table += '</table>';
							$('#'+attribute.cscfga__Type__c.split(' ').join('')+'-selectOptionsDiv').children().remove();
							$('#'+attribute.cscfga__Type__c.split(' ').join('')+'-selectOptionsDiv').append(table);
						}
						if (attribute.cscfga__Select_Options__r != undefined && attribute.cscfga__Select_Options__r.length > 0) {
							//
							$(document).ready(function() {
							    $('#'+attribute.cscfga__Type__c.split(' ').join('')+'-selectOptionsDiv > table').tableDnD();
							    //
							    
							    keys = new KeyTable({"table": document.getElementById(attribute.cscfga__Type__c.split(' ').join('')+'-selectOptions')});
							    /*********/
							    $('#'+attribute.cscfga__Type__c.split(' ').join('')+'-selectOptions tbody td').each( function () {
							    	if (keys != undefined)
										keys.event.remove.action(this);
								});
								/*******/
								//
							    /* Apply a return key event to each cell in the table */
								/**********/
								$('#'+attribute.cscfga__Type__c.split(' ').join('')+'-selectOptions tbody td').each( function () {
									if (keys != undefined) {
										keys.event.action( this, function (nCell) {
											// Block KeyTable from performing any events while jEditable is in edit mode
											keys.block = true;
											console.log('nCell: '+nCell);
											// Initialise the Editable instance for this table
											$(nCell).editable( function (sVal) {
												// Submit function (local only) - unblock KeyTable
												keys.block = false;
												return sVal;
											}, { 
												"onblur": 'submit', 
												"onreset": function(){ 
													// Unblock KeyTable, but only after this 'esc' key event has finished. Otherwise
													// it will 'esc' KeyTable as well
													//
													setTimeout( function () {keys.block = false;}, 0); 
												},
												"placeholder": ' '
											} );
											// Dispatch click event to go into edit mode - Saf 4 needs a timeout... 
											setTimeout( function () { $(nCell).click(); }, 0 );
										} );
									}
								} );
								/******/
								//
								/*****/
								$('#'+attribute.cscfga__Type__c.split(' ').join('')+'-selectOptions tbody td').editable(
									function (sVal) {
										// Submit function (local only) - unblock KeyTable
										keys.block = false;
										return sVal;
									}, 
									{ 
									    "event"     : "dblclick",
										"onblur": 'submit',
										"placeholder": ' ', 
										"onreset": function(){ 
											// Unblock KeyTable, but only after this 'esc' key event has finished. Otherwise
											// it will 'esc' KeyTable as well
											//
											setTimeout( function () {keys.block = false;}, 0); 
										}
									}
								);
								/*****/
							});
						}
						// highlight the selected attribute
						$('.attributeDiv').css('background', '#BCE');
						$('#' + attribute.Id).css('background', '#A4D48C');
						//
						$('.propertyInspector').unblock();
					}
				}
				//
				function addTableRow(tableId,type) {
					var row = '<tr><td style="vertical-align: middle;"><img src="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'delete-12.png')}" style="height: 9px;" onClick="$(this).parent().parent().remove();"/></td><td style="height: 14px;"></td><td style="height: 14px;"></td><td style="height: 14px;"></td></tr>';
					tableId = type+'-'+tableId;
					//console.log(tableId);
					$('#'+tableId).append(row);
					$(document).ready(function() {
						if (keys == undefined) 
					    	keys = new KeyTable({"table": document.getElementById(type+'-selectOptions')});
					    $('#'+tableId).tableDnD();
					    $('#'+type+'-selectOptions tbody td').each( function () {
					    	if (keys != undefined) {
    							keys.event.remove.action(this);
    						} 
						});
					    /* Apply a return key event to each cell in the table */
					    /***************/
						$('#'+type+'-selectOptions tbody td').each( function () {
							if (keys != undefined) {
								//console.log('keys is: '+keys);
								keys.event.action( this, function (nCell) {
									// Block KeyTable from performing any events while jEditable is in edit mode
									keys.block = true;
									
									// Initialise the Editable instance for this table 
									$(nCell).editable( function (sVal) {
										// Submit function (local only) - unblock KeyTable 
										keys.block = false;
										return sVal;
									}, { 
										"onblur": 'submit', 
										"onreset": function(){ 
											// Unblock KeyTable, but only after this 'esc' key event has finished. Otherwise
											// it will 'esc' KeyTable as well
											//
											setTimeout( function () {keys.block = false;}, 0); 
										},
										"placeholder": ' '
									} );
									// Dispatch click event to go into edit mode - Saf 4 needs a timeout... 
									setTimeout( function () { $(nCell).click(); }, 0 );
								} );
							}
						} );
						/***********/
						//
						/*****/
						$('#'+type+'-selectOptions tbody td').editable(
							function (sVal) {
								// Submit function (local only) - unblock KeyTable
								keys.block = false;
								return sVal;
							}, 
							{ 
							    "event"     : "dblclick",
								"onblur": 'submit',
								"placeholder": ' ', 
								"onreset": function(){ 
									// Unblock KeyTable, but only after this 'esc' key event has finished. Otherwise
									// it will 'esc' KeyTable as well
									//
									setTimeout( function () {keys.block = false;}, 0); 
								}
							}
						);
						/*****/
					});
				}
				//
				function saveAttribute(button, attId,inspectorType) {
					// Get attribute details
					var attribute = {};//{"Id":"","Name":"","cscfga__Label__c":""};
					attribute["Id"] = attId;
					//
					var currentPropertyInspector = '#'+$(button).parent().parent().parent().parent().parent().attr('Id');
					console.log(currentPropertyInspector);
					console.log(attId);
					console.log(button.parent().parent().parent().parent().parent().attr('Id'));
					//
					$(currentPropertyInspector+' > table').find('.field-label').each(function () {
						var fieldLabel = $.trim($(this).text());
						if (fieldLabel == 'Name') attribute["Name"] = $(this).next().find('input').val();
						if (fieldLabel == 'Label') attribute["cscfga__Label__c"] = $(this).next().find('textarea').val();
						if (fieldLabel == 'Lookup Config') {
							var lookupFieldDescInputId = $(this).next().find('.lookupInput').find('input').attr('Id');
							attribute["cscfga__Lookup_Config__c"] = $('#'+escapeId(lookupFieldDescInputId)+'_lkid').val();
						}
						if (fieldLabel == 'Type') attribute["cscfga__Type__c"] = $(this).next().find('select').val();
						if (fieldLabel == 'Required') {
							if ($(this).next().find('input').prop('checked')) {
								attribute["cscfga__Required__c"] = true;
							} else {
								attribute["cscfga__Required__c"] = false;
							}
						}
						if (fieldLabel == 'Data Type') attribute["cscfga__Data_Type__c"] = $(this).next().find('select').val();
						if (fieldLabel == 'Default Value') attribute["cscfga__Default_Value__c"] = $(this).next().find('textarea').val();
						if (fieldLabel == 'Is Line Item') {
							if ($(this).next().find('input').prop('checked')) {
								attribute["cscfga__Is_Line_Item__c"] = true;
							} else {
								attribute["cscfga__Is_Line_Item__c"] = false;
							}
						}
						if (fieldLabel == 'Line Item Description') attribute["cscfga__Line_Item_Description__c"] = $(this).next().find('input').val();
						if (fieldLabel == 'Line Item Sequence') attribute["cscfga__Line_Item_Sequence__c"] = $(this).next().find('input').val();
						if (fieldLabel == 'Recurring') {
							if ($(this).next().find('input').prop('checked')) {
								attribute["cscfga__Recurring__c"] = true;
							} else {
								attribute["cscfga__Recurring__c"] = false;
							}
						}
						if (fieldLabel == 'Enable Predictive Search') {
							if ($(this).next().find('input').prop('checked')) {
								attribute["cscfga__Enable_Predictive_Search__c"] = true;
							} else {
								attribute["cscfga__Enable_Predictive_Search__c"] = false;
							}
						}
						if (fieldLabel == 'Enable Null Option') {
							if ($(this).next().find('input').prop('checked')) {
								attribute["cscfga__Enable_null_option__c"] = true;
							} else {
								attribute["cscfga__Enable_null_option__c"] = false;
							}
						}
						if (fieldLabel == 'Enable Multiple Selection') {
							if ($(this).next().find('input').prop('checked')) {
								attribute["cscfga__Enable_Multiple_Selection__c"] = true;
							} else {
								attribute["cscfga__Enable_Multiple_Selection__c"] = false;
							}
						}
						if (fieldLabel == 'Select List Lookup') {
							if ($(this).next().find('input').prop('checked')) {
								attribute["cscfga__Select_List_Lookup__c"] = true;
							} else {
								attribute["cscfga__Select_List_Lookup__c"] = false;
							}
						}
						if (fieldLabel == 'Is Rate Line Item') {
							if ($(this).next().find('input').prop('checked')) {
								attribute["cscfga__Is_Rate_Line_Item__c"] = true;
							} else {
								attribute["cscfga__Is_Rate_Line_Item__c"] = false;
							}
						}
						if (fieldLabel == 'Desynchronises Bundle') {
							if ($(this).next().find('input').prop('checked')) {
								attribute["cscfga__is_significant__c"] = true;
							} else {
								attribute["cscfga__is_significant__c"] = false;
							}
						}
						if (fieldLabel == 'Reference Value') attribute["cscfga__Reference_Value__c"] = $(this).next().find('input').val();
						if (fieldLabel == 'Minimum Input Length') attribute["cscfga__Minimum_Input_Length__c"] = $(this).next().find('input').val();
						if (fieldLabel == 'Column Size CSV') attribute["cscfga__Column_Size_CSV__c"] = $(this).next().find('input').val();
						if (fieldLabel == 'Scale') attribute["cscfga__Scale__c"] = $(this).next().find('input').val();
						if (fieldLabel == 'Text input lines') attribute["cscfga__Text_input_lines__c"] = $(this).next().find('input').val();
						if (fieldLabel == 'Hidden') {
							if ($(this).next().find('input').prop('checked')) {
								attribute["cscfga__Hidden__c"] = true;
							} else {
								attribute["cscfga__Hidden__c"] = false;
							}
						}
						if (fieldLabel == 'Calculation Sequence') attribute["cscfga__Calculation_Sequence__c"] = $(this).next().find('input').val();
						if (fieldLabel == 'Max') attribute["cscfga__Max__c"] = $(this).next().find('input').val();
						if (fieldLabel == 'Min') attribute["cscfga__Min__c"] = $(this).next().find('input').val();
						if (fieldLabel == 'Custom Validation Pattern') attribute["cscfga__Pattern__c"] = $(this).next().find('input').val();
						if (fieldLabel == 'Custom Validation Error Message') attribute["cscfga__Custom_Validation_Error_Message__c"] = $(this).next().find('input').val();
						
						if (fieldLabel == 'Base Price') attribute["cscfga__Base_Price__c"] = $(this).next().find('input').val();
						if (fieldLabel == 'List Columns') attribute["cscfga__List_Columns__c"] = $(this).next().find('input').val();
						if (fieldLabel == 'Output Mapping') attribute["cscfga__Output_Mapping__c"] = $(this).next().find('input').val();
						if (fieldLabel == 'Cascade value') {
							if ($(this).next().find('input').prop('checked')) {
								attribute["cscfga__Cascade_value__c"] = true;
							} else {
								attribute["cscfga__Cascade_value__c"] = false;
							}
						}
					});
					//
					var selectOptList = new Array();
					var k = 0;
					console.log('>>>>>'+attribute["cscfga__Type__c"].split(' ').join('')+'-selectOptions tbody tr');
					$('#'+attribute["cscfga__Type__c"].split(' ').join('')+'-selectOptions tbody tr').each(function(){
						var h = 0;
						var optId = $(this).attr('Id');
						var opt = {};
						console.log('******'+$(this).children('td'));
						$(this).children('td').each(function(){
							if (optId != undefined) opt.Id = optId;
							opt.cscfga__Sequence__c = k; 
							opt.cscfga__Attribute_Definition__c = attribute.Id; 
							if (h == 1) opt.Name = $.trim($(this).text());
							if (h == 2) opt.cscfga__Value__c = $.trim($(this).text());
							if (h == 3) opt.cscfga__Price__c = $.trim($(this).text());
							h++;
						});
						selectOptList.push(opt);
						k++;
					});
					//
					console.log('selectOptList: '+JSON.stringify(selectOptList));
					console.log('attribute: '+JSON.stringify(attribute));
					// de-highlight the selected element
					$('#' + attribute.Id).css('background', '#BCE');
					//
					blockScreenElement('.propertyInspector');
					//
					Visualforce.remoting.Manager.invokeAction(
						'{!$RemoteAction.ProductDesignerController.saveAttribute}',
						JSON.stringify(attribute),
						JSON.stringify(selectOptList),
						handleSaveAttributeResponse,
						{escape: false}
					);
				}
				//
				function handleSaveAttributeResponse(result, event) {
					if (event.type == 'exception') {
						growlNow(event.message);
						//
						$('.propertyInspector').unblock();
					} else {
						growlNow('Attribute record saved successfully');
						//
						var layout = getLayoutString();
						saveLayout('{!cscfga__Product_Definition__c.Id}',layout);
						getOffScreenAttributes('{!cscfga__Product_Definition__c.Id}');
						//
						$('.propertyInspector').children().hide();
						$('.propertyInspector').unblock();
					}
				}
				//
				function saveLayout(productDefinitionId, layout) {
					//
					blockScreenElement('#fullCenterColumn');
					//
					Visualforce.remoting.Manager.invokeAction(
						'{!$RemoteAction.ProductDesignerController.saveProdDefPageLayout}',
						layout, 
						productDefinitionId,
						handleLayoutSaveResponse,
						{escape: false}
					);
				}
				//
				function handleLayoutSaveResponse(result, event) {
					if (event.type == 'exception') {
						growlNow(event.message);
						//
						$('#fullCenterColumn').unblock();
					} else {
						growlNow('Layout saved successfully');
						//
						getOnScreenAttributes('{!cscfga__Product_Definition__c.Id}');
						//
						$('#fullCenterColumn').unblock();
					}
				}
		    	//
				function getScreenDetails(screenId) {
					Visualforce.remoting.Manager.invokeAction(
						'{!$RemoteAction.ProductDesignerController.loadScreenDetails}',
						screenId, 
						handleGetScreenDetailsResponse,
						{escape: false}
					);
				}
				//
				function handleGetScreenDetailsResponse(result, event) {
					if (event.type == 'exception') {
						growlNow(event.message);
						//
						$('.propertyInspector').unblock();
					} else {
						var screen = result;
						blockScreenElement('.propertyInspector');
						// Display the relevant property Inspector: 
						$('.property-inspector').hide();
						var currentPropertyInspector = '#screenPropertyInspector';
						$(currentPropertyInspector).show();
						//
						// set screenId
						$(currentPropertyInspector+' > table').find('.screen-id').val(screen.Id);
						$(currentPropertyInspector+' > table').find('.field-label').each(function () {
							var fieldLabel = $.trim($(this).text());
							//
							if (fieldLabel == 'Name') $(this).next().find('input').val(screen.Name);
							if (fieldLabel == 'Index') $(this).next().find('input').val(screen.cscfga__Index__c);
							if (fieldLabel == 'Show Product Configuration header') {
								if (screen.cscfga__Show_Product_Configuration_header__c) {
									$(this).next().find('input').prop('checked',true);
								} else {
									$(this).next().find('input').prop('checked',false);
								}
							}
							if (fieldLabel == 'Show Configuration and Product Name') {
								if (screen.cscfga__Show_Configuration_and_Product_Name__c) {
									$(this).next().find('input').prop('checked',true);
								} else {
									$(this).next().find('input').prop('checked',false);
								}
							}
						});
						//
						$('.propertyInspector').unblock();
					}
				}
				//
				function saveScreen(button, screenId) {
					// Save screen details
					var screen = {};
					screen["Id"] = screenId;
					//
					var currentPropertyInspector = '#'+$(button).parent().parent().parent().parent().parent().attr('Id');
					console.log(currentPropertyInspector);
					console.log(screenId);
					console.log(button.parent().parent().parent().parent().parent().attr('Id'));
					//
					$(currentPropertyInspector+' > table').find('.field-label').each(function () {
						var fieldLabel = $.trim($(this).text());
						if (fieldLabel == 'Name') screen["Name"] = $(this).next().find('input').val();
						if (fieldLabel == 'Index') screen["cscfga__Index__c"] = $(this).next().find('input').val();
						if (fieldLabel == 'Show Product Configuration header') {
							if ($(this).next().find('input').prop('checked')) {
								screen["cscfga__Show_Product_Configuration_header__c"] = true;
							} else {
								screen["cscfga__Show_Product_Configuration_header__c"] = false;
							}
						}
						if (fieldLabel == 'Show Configuration and Product Name') {
							if ($(this).next().find('input').prop('checked')) {
								screen["cscfga__Show_Configuration_and_Product_Name__c"] = true;
							} else {
								screen["cscfga__Show_Configuration_and_Product_Name__c"] = false;
							}
						}
					});
					console.log('screen: '+JSON.stringify(screen));
					//
					blockScreenElement('.propertyInspector');
					// 
					Visualforce.remoting.Manager.invokeAction(
						'{!$RemoteAction.ProductDesignerController.saveScreen}',
						JSON.stringify(screen), 
						handleSaveScreenResponse,
						{escape: false}
					);
				}
				//
				function handleSaveScreenResponse(result, event) {
					if (event.type == 'exception') {
						growlNow(event.message);
						//
						$('.propertyInspector').unblock();
					} else {
						growlNow('Screen record saved successfully');
						//
						loadScreenList('{!cscfga__Product_Definition__c.Id}');
						// Get On Screen Attributes
						getOnScreenAttributes('{!cscfga__Product_Definition__c.Id}');
						//
						$('.propertyInspector').children().hide();
						$('.propertyInspector').unblock();
					}
				}
		    	//
				function getSectionDetails(sectionId) {
					Visualforce.remoting.Manager.invokeAction(
						'{!$RemoteAction.ProductDesignerController.loadSectionDetails}',
						sectionId, 
						handleGetSectionDetailsResponse,
						{escape: false}
					);
				}
				//
				function handleGetSectionDetailsResponse(result, event) {
					if (event.type == 'exception') {
						growlNow(event.message);
					} else {
						var section = result;
						blockScreenElement('.propertyInspector');
						// Display the relevant property Inspector: 
						$('.property-inspector').hide();
						var currentPropertyInspector = '#sectionPropertyInspector';
						$(currentPropertyInspector).show();
						//
						// set sectionId
						$(currentPropertyInspector+' > table').find('.section-id').val(section.Id);
						$(currentPropertyInspector+' > table').find('.field-label').each(function () {
							var fieldLabel = $.trim($(this).text());
							//
							if (fieldLabel == 'Name') $(this).next().find('input').val(section.Name);
							if (fieldLabel == 'Index') $(this).next().find('input').val(section.cscfga__Index__c);
						});
						//
						$('.propertyInspector').unblock();
					}
				}
				//
				function saveSection(button, sectionId) {
					// Save section details
					var section = {};
					section["Id"] = sectionId;
					//
					var currentPropertyInspector = '#'+$(button).parent().parent().parent().parent().parent().attr('Id');
					console.log(currentPropertyInspector);
					console.log(sectionId);
					console.log(button.parent().parent().parent().parent().parent().attr('Id'));
					//
					$(currentPropertyInspector+' > table').find('.field-label').each(function () {
						var fieldLabel = $.trim($(this).text());
						if (fieldLabel == 'Name') section["Name"] = $(this).next().find('input').val();
						if (fieldLabel == 'Index') section["cscfga__Index__c"] = $(this).next().find('input').val();
					});
					console.log('section: '+JSON.stringify(section));
					//
					blockScreenElement('.propertyInspector');
					// 
					Visualforce.remoting.Manager.invokeAction(
						'{!$RemoteAction.ProductDesignerController.saveSection}',
						JSON.stringify(section), 
						handleSaveSectionResponse,
						{escape: false}
					);
				}
				//
				function handleSaveSectionResponse(result, event) {
					if (event.type == 'exception') {
						growlNow(event.message);
						//
						$('.propertyInspector').unblock();
					} else {
						growlNow('Section record saved successfully');
						// Get On Screen Attributes
						getOnScreenAttributes('{!cscfga__Product_Definition__c.Id}');
						//
						$('.propertyInspector').children().hide();
						$('.propertyInspector').unblock();
					}
				}
		    	//
				function getOffScreenAttributes(productId) {
					Visualforce.remoting.Manager.invokeAction(
						'{!$RemoteAction.ProductDesignerController.getOffScreenAttributeDefinitions}',
						productId, 
						handleGetOffScreenAttributeDefinitionsResponse,
						{escape: false}
					);
				}
				//
				function handleGetOffScreenAttributeDefinitionsResponse(result, event) {
					if (event.type == 'exception') {
						growlNow(event.message);
						//
						$('#unusedComponentsTable').unblock();
					} else {
						var attributeList = result;
						blockScreenElement('#unusedComponentsTable');
						// Display the relevant components div: 
						$('#unusedComponentsTable').show();
						$('#ruleComponents').hide();
						//
						var div = '';
						for (i = 0; i < attributeList.length; i++) {
							var att = attributeList[i];
							////console.log(att.Name);
							div += createAttributeDiv(att,'offScreen');
						}
						//
						$('#unusedComponentsTable').children().remove();
						$('#unusedComponentsTable').append(div);
						$('#unusedComponentsTable').find('.toggle-image').hide();
						//
						initialiseDragDrop();
						//
						getExpressionOptions();
						//
						$('#unusedComponentsTable').unblock();
					}
				}
		    	//
				function getOnScreenAttributes(productId) {
					Visualforce.remoting.Manager.invokeAction(
						'{!$RemoteAction.ProductDesignerController.getOnScreenAttributeDefinitions}',
						productId, 
						handleGetOnScreenAttributeDefinitionsResponse,
						{escape: false}
					);
				}
				//
				function handleGetOnScreenAttributeDefinitionsResponse(result, event) {
					if (event.type == 'exception') {
						growlNow(event.message);
						//
						$('#screens').unblock();
					} else {
						var screenList = result;
						blockScreenElement('#screens');
						$('#screens').children().remove();
						//
						for (i = 0; i < screenList.length; i++) {
							var oldRow = -1;
							var oldCol = -1;
							var oldSpan = -1;
							//
							var screen = screenList[i];
							if (screen.cscfga__Screen_Flow__c == undefined) {
								$('#screens').append(createScreen(screen));
								$('#'+screen.Id).append(createSection('general-info',null,'General Information', screen.Id));
								$('#'+screen.Id).append(createSection('related-lists',null,'Related Lists - Related Products &amp; Multiselect Lookups', screen.Id));
								// Sections:
								for (j = 0; j < (screen.cscfga__Screen_Sections__r == undefined ? 0 : screen.cscfga__Screen_Sections__r.length); j++) {
									var section = screen.cscfga__Screen_Sections__r[j];
									$('#related-lists-'+screen.Id).before(createSection('dynamic',section,section.Name, screen.Id));
								}
								// Attributes:
								var oldSectionId
								for (j = 0; j < (screen.cscfga__Attribute_Definitions__r == undefined ? 0 : screen.cscfga__Attribute_Definitions__r.length); j++) {
									//
									var attribute = screen.cscfga__Attribute_Definitions__r[j];
									//
									var sectionId;
									if (attribute.cscfga__Screen_Section__c != undefined) {
										sectionId = attribute.cscfga__Screen_Section__c;
									} else if (attribute.cscfga__Screen_Section__c == undefined) {
										if ((attribute.cscfga__Type__c == 'Related Product' && attribute.cscfga__Max__c != 1) || 
											(attribute.cscfga__Type__c == 'Lookup' && attribute.cscfga__Enable_Multiple_Selection__c)) {
											sectionId = 'related-lists-'+attribute.cscfga__Configuration_Screen__c;
										} else {
											sectionId = 'general-info-'+attribute.cscfga__Configuration_Screen__c;
										}
									}
									if (oldSectionId != sectionId) {
										oldRow = -1;
										oldCol = -1;
										oldSpan = -1;
									}
									//
									var addSpacer = false;
									//
									if (oldRow != attribute.cscfga__Row__c && attribute.cscfga__Column__c == 1) addSpacer = true;
									if (oldRow != attribute.cscfga__Row__c && oldCol == 0 && oldSpan == 1) addSpacer = true;
									//
									if (attribute.cscfga__Screen_Section__c != undefined) {
										if (addSpacer) $('#usedComponentsTablesX-'+attribute.cscfga__Screen_Section__c).append(addSpacerToScreen());
										$('#usedComponentsTablesX-'+attribute.cscfga__Screen_Section__c).append(createAttributeDiv(attribute,'onScreen'));
									} else if (attribute.cscfga__Screen_Section__c == undefined) {
										if ((attribute.cscfga__Type__c == 'Related Product' && attribute.cscfga__Max__c != 1) || 
											(attribute.cscfga__Type__c == 'Lookup' && attribute.cscfga__Enable_Multiple_Selection__c)) {
											if (addSpacer) $('#usedComponentsTablesX-related-lists-'+attribute.cscfga__Configuration_Screen__c).append(addSpacerToScreen());
											$('#usedComponentsTablesX-related-lists-'+attribute.cscfga__Configuration_Screen__c).append(createAttributeDiv(attribute,'onScreen'));
											//
										} else {
											if (addSpacer) $('#usedComponentsTablesX-general-info-'+attribute.cscfga__Configuration_Screen__c).append(addSpacerToScreen());
											$('#usedComponentsTablesX-general-info-'+attribute.cscfga__Configuration_Screen__c).append(createAttributeDiv(attribute,'onScreen'));
										}
									}
									// Column span
									if (attribute.cscfga__Column_Span__c == 2) colSpanToggle($('#'+attribute.Id).find('.toggle-image'),true);
									//
									oldCol = attribute.cscfga__Column__c;
									oldRow = attribute.cscfga__Row__c;
									oldSpan = attribute.cscfga__Column_Span__c;
									oldSectionId = sectionId;
									//
								}
							}
						}
						//
						// Loop through all sections and add a spacer if they are empty
						$('.section').each(function() {
							if ($(this).children().length == 0) $(this).append(addSpacerToScreen());
						});
						//
						$('#screens').children().hide(); 
						if (sortSaveEvent) {
							$('#Screen-Select').ddslick('select',{index: 0});
							console.log('>>sortSaveEvent: '+sortSaveEvent);
							sortSaveEvent = false;
						} else {
							selectScreen(selectedScreenId);
							console.log('**sortSaveEvent: '+sortSaveEvent);
						}
						//
						initialiseDragDrop();
						$('#screens').unblock();
					}
				}
		    	//
				function loadScreenList(productDefinitionId) {
					Visualforce.remoting.Manager.invokeAction(
						'{!$RemoteAction.ProductDesignerController.getScreenAndSectionList}',
						productDefinitionId, 
						handleLoadScreenListResponse,
						{escape: false}
					);
				}
				//
				function handleLoadScreenListResponse(result, event) {
					if (event.type == 'exception') {
						growlNow(event.message);
					} else {
						var ScreenList = result;
						// Display the relevant property Inspector: 
						$('.property-inspector').hide();
						//
						var screenOption = '';
						for (i = 0; i < ScreenList.length; i++) {
							var screen = ScreenList[i];
							//
							screenOption += '<option value="'+screen.Id+'" data-imagesrc="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'screen-24.png')}">'+screen.Name+'</option>';
						}
						screenOption += '<option id="rules-screen" value="rules-screen" data-imagesrc="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'rule-20.png')}">Manage rules</option>';
						$('#Screen-Select').ddslick('destroy');
						$('#Screen-Select').children().remove();
						$('#Screen-Select').append(screenOption);
						makeScreenSelectListSlick();
						//
						$(document).ready(function() {
							var goToScreens = true;
							switchContext($('#workbench-switcher'),selectedScreenId,goToScreens);
							$('#screens').children().first().siblings().hide();
						});
					}
				}
				//
				function createScreen(screen) {
					var screenDiv = '';
					screenDiv += '<div class="screen" id="'+screen.Id+'" style="border:1px solid #666666; min-height: 465px; background: #ECF3F8;">';
					screenDiv += '</div>';
					//
					return screenDiv; 
				}
				//
				function createSection(type, section, sectionName, screenId) {
					var sectionId;
					if (type == 'dynamic') {
						sectionId =  section.Id;
					} else {
						sectionId = type+'-'+screenId; 
					}
					var sectionFieldSet = '';
					sectionFieldSet += '<fieldset id="'+sectionId+'" style="border:1px solid #666666;margin: 5px;background:#ffffff;">';
                    sectionFieldSet += '	<legend>';
                    sectionFieldSet += 			sectionName; 
                    if (type == 'dynamic') {
                    	sectionFieldSet += '		<img class="section-image" title="Section settings" src="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'edit-settings-12.png')}" onClick="getSectionDetails($(this).parent().parent().attr(\'id\'));"/>';
                    	sectionFieldSet += '		<img class="section-image" title="Delete section" src="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'delete-12.png')}" onClick="deleteSection($(this).parent().parent());"/>';
                    }
                    sectionFieldSet += '		<img class="section-image" title="Toggle general information" id="general-info-toggle-image" src="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'collapse-12.png')}" onClick="toggleSectionDisplay(this);"/>';
                    sectionFieldSet += '	</legend>';
                    sectionFieldSet += '    <div class="div-table doubleColumnTableSize section" id="usedComponentsTablesX-'+sectionId+'">';
                    sectionFieldSet += '    </div>';
                	sectionFieldSet += '</fieldset>';
                	//
                	return sectionFieldSet;
				}
				//
				function createAttributeDiv(att,componentLocation) {
					// Create an object to store attribute images
					var attributeImage = {
						"Calculation": "{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'calculation-20.png')}",
						"Checkbox": "{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'checkbox-20.png')}",
						"Date": "{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'date-20.png')}",
						"Lookup": "{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'lookup-20.png')}",
						"Radio Button": "{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'radio-20.png')}",
						"Related Product": "{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'related-product-20.png')}",
						"Select List": "{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'select-list-20.png')}",
						"Text Display": "{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'text-display-20.png')}",
						"User Input": "{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'user-input-20.png')}",
						"Spacer": "{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'spacer-20.png')}"
					};
					//
					var div = '<div class="draggableCell singleCellSize attributeDiv" id="'+att.Id+'" value="'+att.cscfga__Type__c+'" attType="'+att.cscfga__Type__c+'" attMax="'+att.cscfga__Max__c+'" attMultiSelect="'+att.cscfga__Enable_Multiple_Selection__c+'" title="'+att.Name+'">';
                    if (att.cscfga__Required__c) div += '<div class="required"></div>';
                    div += '<img class="label-image" title="" src="'+attributeImage[att.cscfga__Type__c]+'" style="width: 12px; height:12px;"/>';
                    div += att.Name.substring(0,{!$Setup.cspduia__Product_Designer_Options__c.cspduia__Attribute_Name_Display_Length__c});
                    if (componentLocation == 'offScreen') {
                    	div += '<img class="delete-image" title="Delete attribute" src="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'delete-12.png')}" id="deleteIcon-'+att.id+'" onClick="deleteAttribute(\''+att.Id+'\')"/>';
                    } else {
                    	div += '<img class="remove-image" title="Remove attribute" src="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'remove-attribute-12.png')}" id="deleteIcon-'+att.id+'" onClick="removeAttributeFromScreen(\''+att.Id+'\',\'single delete\')"/>';
                    }
                    div += '<img class="toggle-image" title="Toggle column span" src="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'expand-column-12.png')}" id="toggleIcon-'+att.id+'" onClick="colSpanToggle(this);"/>';
                    div += '<img class="setup-image" title="Attribute settings" src="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'edit-settings-12.png')}" id="setupIcon-'+att.id+'" onClick="getAttributeDetails(\''+att.Id+'\')"/>';
                    div += '</div>';
                    return div;
				}
				//
				function addSpacerToScreen() {
					return '<div class="draggableCell singleCellSizeSpacer spacerDiv" value="Spacer">'+
						'<img class="label-image" src="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'spacer-20.png ')}" '+
						'title="Spacer" style="width: 12px; height:12px;"/><img class="delete-image" title="Delete spacer" '+
						'src="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'delete-12.png ')}"  '+
						'onClick="$(this).parent().remove();"/></div>';
				}
				//
				function getScreensAndSectionsForSorting(productId) {
					//
					blockScreenElement('.propertyInspector');
					//
					Visualforce.remoting.Manager.invokeAction(
						'{!$RemoteAction.ProductDesignerController.getScreenAndSectionList}',
						productId, 
						handleGetScreenAndSectionListResponse,
						{escape: false}
					);
				}
				//
				function handleGetScreenAndSectionListResponse(result, event) {
					if (event.type == 'exception') {
						growlNow(event.message);
					} else {
						var ScreenList = result;
						// Display the relevant property Inspector: 
						$('.property-inspector').hide();
						var currentPropertyInspector = '#screenSortProperties';
						$(currentPropertyInspector).show();
						//
						var screenUl = '';
						for (i = 0; i < ScreenList.length; i++) {
							var screen = ScreenList[i];
							//
							screenUl += '<li class="screen-sort-li" id="sort-li-'+screen.Id+'" valueId="'+screen.Id+'">'+screen.Name+'</li>';
							//
							var sectionList = screen.cscfga__Screen_Sections__r;
							//
							screenUl += '<li id="sort-li-'+screen.Id+'-ul" style="list-Style: none;">';
							screenUl += '  <ul class="Section-Select-Sort connectedSortable"  id="sort-ul-'+screen.Id+'" style="min-height:10px;">';
							//
							for (j = 0; j < (sectionList == undefined ? 0 : sectionList.length); j++) {
								var section = sectionList[j];
								screenUl += '    <li class="section-sort-li" valueId="'+section.Id+'">'+section.Name+'</li>';
							}
							//
							screenUl += '  </ul>';
							screenUl += '</li>';
						}
						$('.Screen-Select-Sort').children().remove();
						$('.Screen-Select-Sort').append(screenUl);
						//
						$(function() {
							$( ".Screen-Select-Sort" ).sortable({placeholder: "Screen-Select-Sort", cursor: "move",
								stop: function( event, ui ) {
									childElementId = $(ui.item).attr('id');
									$(ui.item).after($('#'+childElementId+'-ul'));
								}
							});
							$( ".Screen-Select-Sort" ).disableSelection();
							$( ".Section-Select-Sort" ).sortable({connectWith: ".connectedSortable",placeholder: "Screen-Select-Sort", cursor: "move"});
							$( ".Section-Select-Sort" ).disableSelection();
						});
						//
						$('.propertyInspector').unblock();
					}
				}
				//
				function screenSaveSort() {
					//
					blockScreenElement('.propertyInspector');
					// Get the new layout of the sections
					var screenLayoutString = '';
					var i = 1;
					$('.Screen-Select-Sort > li.screen-sort-li').each(function () {
						//console.log('**Screen: ' + $(this).attr('valueId'));
						screenLayoutString += $(this).attr('valueId') + '-';
						var nextUl = $(this).next('li').find('ul.Section-Select-Sort');
						var j = 1;
						$(nextUl).children('li').each(function () {
							//console.log('**Section: ' + $(this).attr('valueId'));
							screenLayoutString += $(this).attr('valueId');
							if (j != $(nextUl).children('li').size()) {
								screenLayoutString += ':';
							}
							j++;
						});
						if (i != $('.Screen-Select-Sort > li.screen-sort-li').size()) {
							screenLayoutString += ';';
						}
						i++;
					});
					//console.log('screenLayoutString: ' + screenLayoutString);
					var layout = getLayoutString();
					saveLayout('{!cscfga__Product_Definition__c.Id}',layout);
					//
					Visualforce.remoting.Manager.invokeAction(
						'{!$RemoteAction.ProductDesignerController.saveScreenSort}',
						screenLayoutString, 
						'{!cscfga__Product_Definition__c.Id}', 
						handleScreenSortSaveResponse,
						{escape: false}
					);
				}
				//
				function handleScreenSortSaveResponse(result, event) {
					if (event.type == 'exception') {
						growlNow(event.message);
					} else {
						growlNow('Screen and Section order saved successfully');
						//
						sortSaveEvent = true;
						selectedScreenId = '';
						loadScreenList('{!cscfga__Product_Definition__c.Id}');
						getOnScreenAttributes('{!cscfga__Product_Definition__c.Id}');
						$('.propertyinspector').hide();
						//
						$('.propertyInspector').unblock();
					}
				}
				//
				function getCalculationAttributesForSorting(productId) {
					//
					blockScreenElement('.propertyInspector');
					//
					Visualforce.remoting.Manager.invokeAction(
						'{!$RemoteAction.ProductDesignerController.getCalculationAttributeList}',
						productId, 
						handleCalculationAttributeListResponse,
						{escape: false}
					);
				}
				//
				function handleCalculationAttributeListResponse(result, event) {
					if (event.type == 'exception') {
						growlNow(event.message);
					} else {
						var calcAttributeList = result;
						// Display the relevant property Inspector: 
						$('.property-inspector').hide();
						var currentPropertyInspector = '#attributeSortProperties';
						$(currentPropertyInspector).show();
						//
						var calcAttributeUl = '';
						for (i = 0; i < calcAttributeList.length; i++) {
							var calcAttribute = calcAttributeList[i];
							//
							calcAttributeUl += '<li class="CalcAttribute-sort-li" id="sort-li-'+calcAttribute.Id+'" valueId="'+calcAttribute.Id+'">'+calcAttribute.Name+'</li>';
							//
						}
						$('.CalcAttribute-Select-Sort').children().remove();
						$('.CalcAttribute-Select-Sort').append(calcAttributeUl);
						//
						$(function() {
							$( ".CalcAttribute-Select-Sort" ).sortable({placeholder: "CalcAttribute-Select-Sort", cursor: "move"});
							$( ".CalcAttribute-Select-Sort" ).disableSelection();
						});
						//
						$('.propertyInspector').unblock();
					}
				}
				//
				function calcAttributeSaveSort() {
					//
					blockScreenElement('.propertyInspector');
					// Get the new layout of the sections
					var calcAttributeSequenceString = '';
					var i = 1;
					$('.CalcAttribute-Select-Sort > li.CalcAttribute-sort-li').each(function () {
						calcAttributeSequenceString += $(this).attr('valueId');
						if (i != $('.CalcAttribute-Select-Sort > li.CalcAttribute-sort-li').size()) {
							calcAttributeSequenceString += ';';
						}
						i++;
					});
					//
					Visualforce.remoting.Manager.invokeAction(
						'{!$RemoteAction.ProductDesignerController.saveCalcAttributeSort}',
						calcAttributeSequenceString, 
						'{!cscfga__Product_Definition__c.Id}',
						($('#baseSequence').val() == undefined || $('#baseSequence').val() == '' ? 0 : $('#baseSequence').val()), 
						handleCalcAttributeSortSaveResponse,
						{escape: false}
					);
				}
				//
				function handleCalcAttributeSortSaveResponse(result, event) {
					if (event.type == 'exception') {
						growlNow(event.message);
					} else {
						growlNow('Calculation Attributes order saved successfully');
						//
						sortSaveEvent = true;
						selectedScreenId = '';
						loadScreenList('{!cscfga__Product_Definition__c.Id}');
						getOnScreenAttributes('{!cscfga__Product_Definition__c.Id}');
						$('.propertyinspector').hide();
						//
						$('.propertyInspector').unblock();
					}
				}
				//
				function displaySortScreen(sortComponent,productDefinitionId) {
					console.log('sortComponent: '+sortComponent);
					if (sortComponent == 'Screens') {
						getScreensAndSectionsForSorting(productDefinitionId);
						$('#screenSort').val('Sort');
						$('#attributeSort').val('Sort');
					} else if (sortComponent == 'Attributes') {
						getCalculationAttributesForSorting(productDefinitionId);
						$('#screenSort').val('Sort');
						$('#attributeSort').val('Sort');
					}
				}
		    	//
				function loadRuleList(productDefinitionId) {
					blockScreenElement('#centerColumn');
					// 
					Visualforce.remoting.Manager.invokeAction(
						'{!$RemoteAction.ProductDesignerController.getRuleList}',
						productDefinitionId, 
						handleLoadRuleListResponse,
						{escape: false}
					);
				}
				//
				function handleLoadRuleListResponse(result, event) {
					if (event.type == 'exception') {
						growlNow(event.message);
					} else {
						var ruleList = result;
						var ruleDiv = '';
						//
						$('#rules-screen').remove();
						//
						ruleDiv += '<div class="screen" id="rules-screen" style="border:1px solid #666666; min-height: 465px; background: #ECF3F8;">';
						ruleDiv += '    <fieldset id="rules-{!cscfga__Product_Definition__c.Id}" style="border:1px solid #666666;margin: 5px;background:#ffffff;">';
						ruleDiv += '        <legend>';
						ruleDiv += '            Rules';
						ruleDiv += '            <img class="section-image" title="Toggle rules section" id="rules-toggle-image" src="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'expand-12.png')}" onClick="toggleSectionHeight(this);"/>';
						ruleDiv += '        </legend>';
						ruleDiv += '        <div class="div-block doubleColumnTableSize" id="usedComponentsTablesX-relatedlists-rules">';
						ruleDiv += '            <ul class="rule-div" id="rule-div">';
						for (i = 0; i < (ruleList == undefined ? 0 : ruleList.length); i++) {	
							var rule = ruleList[i];
							//
							//console.log('rule record: '+rule.Name+' - '+rule.cscfga__Active__c);
							//
							ruleDiv += '<li class="rule-li" id="rule-li-'+rule.Id+'" valueId="'+rule.Id+'" title="'+rule.cscfga__Description__c+'">';
							if (rule.cscfga__Active__c)
								ruleDiv += '       <img class="label-image" title="Toggle rule (Currently active)" src="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'active-16.png')}" onClick="toggleRule(\''+rule.Id+'\');"/>';
							if (!rule.cscfga__Active__c)
								ruleDiv += '       <img class="label-image" title="Toggle rule (Currently inactive)" src="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'inactive-16.png')}" onClick="toggleRule(\''+rule.Id+'\');"/>';
							ruleDiv += '   <b class="handle">'+rule.Name+':</b> '+rule.cscfga__Description__c.substring(0,{!$Setup.cspduia__Product_Designer_Options__c.cspduia__Rule_Description_Display_Length__c});
							ruleDiv += '   <img class="setup-image" title="Section settings" src="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'edit-settings-12.png')}" onClick="loadRuleDetails(\''+rule.Id+'\');"/>';
							ruleDiv += '   <img class="setup-image" title="Delete rule" src="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'delete-12.png')}" onClick="deleteRule(\''+rule.Id+'\',\''+rule.Name+'\');"/>';
							ruleDiv += '</li>';
						}
						ruleDiv += '            </ul>';
						ruleDiv += '        </div>';
						ruleDiv += '    </fieldset>';
						ruleDiv += '    <div id="ruleDetailsContainer"> </div>';
						ruleDiv += '</div>';
						//console.log('ruleDiv: '+ruleDiv);
					}
					//
					$('#screens').children().hide();
					$('#screens').append(ruleDiv);
					//
					$('#rules-screen').find('fieldset').show();
					$('.all-contexts').show();
					$('.rule-contexts').show();
					$('.screen-contexts').hide();
					selectScreen('rules-screen');
					$('#rules-screen').siblings().hide();
					$('input[value*="rules-screen"]').parent().parent().show();
					$('input[value*="rules-screen"]').parent().parent().siblings().hide();
					$('#save-image').attr('onClick','saveRuleSequencing();');
					//
					if (createdRuleId != '') {
						//highlightNewRule(createdRuleId);
						loadRuleDetails(createdRuleId);
					}
					//
					makeRulesSortable();
					//
					$('.outer').unblock();
					$('#centerColumn').unblock();
				}
				//
				function loadRuleDetails(ruleId) {
					selectedAttributeId = '';
					//console.log('**ruleId: ' + ruleId);
					// highlight the selected rule
					//$('#rule-li-' + ruleId).css('background', '#A4D48C');
					//$('#rule-li-' + ruleId).siblings().css('background', '#BCE');
					$('.rule-li').css('background', '#BCE');
					highlightNewRule(ruleId);
					//
					blockScreenElement('#centerColumn');
					blockScreenElement('.propertyInspector');
					//
					Visualforce.remoting.Manager.invokeAction(
						'{!$RemoteAction.ProductDesignerController.loadRuleDetails}',
						ruleId, 
						handleLoadRuleDetailsResponse,
						{escape: false}
					);
				}
				//
				function handleLoadRuleDetailsResponse(result, event) {
					if (event.type == 'exception') {
						growlNow(event.message);
					} else {
						var rule = result;
						//
						blockScreenElement('.propertyInspector');
						// Display the relevant property Inspector: 
						$('.property-inspector').hide();
						var currentPropertyInspector = '#rulePropertyInspectorId';
						$(currentPropertyInspector).show();
						//
						console.log('Rule Active Flag: '+rule.cscfga__Active__c);
						// set ruleId
						$(currentPropertyInspector+' > table').find('.rule-id').val(rule.Id);
						$(currentPropertyInspector+' > table').find('.field-label').each(function () {
							var fieldLabel = $.trim($(this).text());
							//
							if (fieldLabel == 'Number') $(this).next().find('span').html(rule.Name);
							if (fieldLabel == 'Active') {
								if (rule.cscfga__Active__c) {
									console.log('***: '+$(this).next().find('input').attr('Id'));
									$(this).next().find('input').prop('checked',true);
								} else {
									$(this).next().find('input').prop('checked',false);
								}
							}
							if (fieldLabel == 'Grouping') $(this).next().find('input').val(rule.cscfga__Grouping__c);
							if (fieldLabel == 'Logic') $(this).next().find('input').val(rule.cscfga__Logic__c);
						});
						//
						$('.propertyInspector').unblock();
						//
						// Now load the predicate and action associations
						var ruleAssociationsDiv = '';
						//
						ruleAssociationsDiv += '<fieldset id="predicates-{!cscfga__Product_Definition__c.Id}" style="border:1px solid #666666;margin: 5px;background:#ffffff;">';
                        ruleAssociationsDiv += '   	<legend>';
                        ruleAssociationsDiv += '   		Rule predicates';
						ruleAssociationsDiv += '            <img class="section-image" title="Toggle section" id="rules-toggle-image" src="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'expand-12.png')}" onClick="toggleSectionHeight(this);"/>';
						ruleAssociationsDiv += '    </legend>';
                        ruleAssociationsDiv += '   	<div class="div-block doubleColumnTableSize" id="usedComponentsTablesX-relatedlists-predicates">';
                        ruleAssociationsDiv += '    	<ul class="rule-div" id="predicate-div">';
						var predicateList = rule.cscfga__Predicate_Associations__r;
						for (i = 0; i < (predicateList == undefined ? 0 : predicateList.length); i++) {
							var predicateAssoc = predicateList[i];
							var subject = (predicateAssoc.cscfga__Predicate__r.cscfga__Subject__c == undefined ? predicateAssoc.cscfga__Predicate__r.cscfga__Product_Definition__c : predicateAssoc.cscfga__Predicate__r.cscfga__Subject__c);
							ruleAssociationsDiv += '<li class="rule-li" onClick="openRuleComponentsDetails($(\'#predicate-action-div-'+subject+'\').parent().find(\'.hierarchy-image\'),\''+subject+'\');" id="'+predicateAssoc.cscfga__Predicate__c+'" value="'+predicateAssoc.Id+'" title="'+predicateAssoc.cscfga__Predicate__r.cscfga__Label__c+'">';
                           	ruleAssociationsDiv += '	<b class="handle">'+predicateAssoc.cscfga__Predicate__r.Name+' ('+predicateAssoc.Name+'):</b> '+predicateAssoc.cscfga__Predicate__r.cscfga__Label__c.substring(0,{!$Setup.cspduia__Product_Designer_Options__c.cspduia__Predicate_Label_Assoc_Display_Length__c});
                            ruleAssociationsDiv += '	<img class="setup-image" title="Delete predicate association" src="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'delete-12.png')}" onClick="$(this).parent().remove();"/>';
                           	ruleAssociationsDiv += '</li>';
						}
                    	ruleAssociationsDiv += '		</ul>';
                        ruleAssociationsDiv += '	</div>';
                        ruleAssociationsDiv += '</fieldset>';
						//
						ruleAssociationsDiv += '<fieldset id="actions-{!cscfga__Product_Definition__c.Id}" style="border:1px solid #666666;margin: 5px;background:#ffffff;">';
                        ruleAssociationsDiv += '   	<legend>';
                        ruleAssociationsDiv += '   		Rule actions - Normal: execute when predicate logic is true';
						ruleAssociationsDiv += '            <img class="section-image" title="Toggle section" id="rules-toggle-image" src="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'expand-12.png')}" onClick="toggleSectionHeight(this);"/>';
						ruleAssociationsDiv += '    </legend>';
                        ruleAssociationsDiv += '   	<div class="div-block doubleColumnTableSize" id="usedComponentsTablesX-relatedlists-predicates">';
                        ruleAssociationsDiv += '    	<ul class="rule-div" id="action-normal-div">';
                    	ruleAssociationsDiv += '		</ul>';
                        ruleAssociationsDiv += '	</div>';
                        ruleAssociationsDiv += '</fieldset>';
                        //
						ruleAssociationsDiv += '<fieldset id="actions-{!cscfga__Product_Definition__c.Id}" style="border:1px solid #666666;margin: 5px;background:#ffffff;">';
                        ruleAssociationsDiv += '   	<legend>';
                        ruleAssociationsDiv += '   		Rule actions - Else: execute when predicate logic is false';
						ruleAssociationsDiv += '            <img class="section-image" title="Toggle section" id="rules-toggle-image" src="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'expand-12.png')}" onClick="toggleSectionHeight(this);"/>';
						ruleAssociationsDiv += '    </legend>';
                        ruleAssociationsDiv += '   	<div class="div-block doubleColumnTableSize" id="usedComponentsTablesX-relatedlists-predicates">';
                        ruleAssociationsDiv += '    	<ul class="rule-div" id="action-else-div">';
                    	ruleAssociationsDiv += '		</ul>';
                        ruleAssociationsDiv += '	</div>';
                        ruleAssociationsDiv += '</fieldset>';
                        //
						//console.log(ruleAssociationsDiv);
						$('#ruleDetailsContainer').children().remove();
						$('#ruleDetailsContainer').append(ruleAssociationsDiv);
						//
						var actionList = rule.cscfga__Rule_Action_Associations__r;
						for (i = 0; i < (actionList == undefined ? 0 : actionList.length); i++) {
							var actionAssoc = actionList[i];
							var actionAssocDiv = '';
							var target = (actionAssoc.cscfga__Action__r.cscfga__Target__c == undefined ? actionAssoc.cscfga__Action__r.cscfga__Product_Definition__c : actionAssoc.cscfga__Action__r.cscfga__Target__c);
							actionAssocDiv += '<li class="rule-li" onClick="openRuleComponentsDetails($(\'#predicate-action-div-'+target+'\').parent().find(\'.hierarchy-image\'),\''+target+'\');" id="'+actionAssoc.cscfga__Action__c+'" value="'+actionAssoc.Id+'" title="'+actionAssoc.cscfga__Label__c+'">';
							actionAssocDiv += '	<b class="handle">'+actionAssoc.cscfga__Action__r.Name+' ('+actionAssoc.Name+'):</b> '+actionAssoc.cscfga__Label__c.substring(0,{!$Setup.cspduia__Product_Designer_Options__c.cspduia__Action_Label_Assoc_Display_Length__c});
			                actionAssocDiv += '	<img class="setup-image" title="Delete action association" src="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'delete-12.png')}" onClick="$(this).parent().remove();"/>';
							actionAssocDiv += '</li>';
							//
							if (actionAssoc.cscfga__Execution_type__c == 'Normal [execute when predicate logic is true]') {
								$('#action-normal-div').append(actionAssocDiv);
							} else {
								$('#action-else-div').append(actionAssocDiv);
							}
						}
						//
						makeRulesSortable();
						//
					}
					//
					$('#centerColumn').unblock();
					$('.propertyInspector').unblock();
				}
				//
				function loadPredicateDetails(predicateId,type) {
					selectedAttributeId = '';
					//console.log('**predicateId: ' + predicateId);
					// highlight the selected rule
					$('.rule-li').css('background', '#BCE');
					$('#' + predicateId).css('background', '#A4D48C');
					//$('#' + predicateId).siblings().css('background', '#BCE');
					//
					blockScreenElement('.propertyInspector');
					// Display the relevant property Inspector: 
					$('.property-inspector').hide();
					var currentPropertyInspector = '#predicatePropertyInspector-'+type;
					$(currentPropertyInspector).show();
					//
					Visualforce.remoting.Manager.invokeAction(
						'{!$RemoteAction.ProductDesignerController.loadPredicateDetails}',
						predicateId, 
						handleLoadPredicateDetailsResponse,
						{escape: false}
					);
					//
				}
				//
				function handleLoadPredicateDetailsResponse(result, event) {
					if (event.type == 'exception') {
						growlNow(event.message);
					} else {
						var predicate = result;
						//
						var currentPropertyInspector = '#predicatePropertyInspector-';
						if (predicate.cscfga__Product_Definition__c == undefined) {
							currentPropertyInspector += 'attribute';
						} else {
							currentPropertyInspector += 'product';
						}
						// set predicateId
						$(currentPropertyInspector+' > table').find('.predicate-id').val(predicate.Id);
						//
						$(currentPropertyInspector+' > table').find('.field-label').each(function () {
							var fieldLabel = $.trim($(this).text());
							//
							if (fieldLabel == 'Number') $(this).next().find('span').html(predicate.Name);
							if (fieldLabel == 'Product Definition') {
								var lookupFieldDescInputId = $(this).next().find('.lookupInput').find('input').attr('Id'); 
								$('#'+escapeId(lookupFieldDescInputId)).val((predicate.cscfga__Product_Definition__r.Name == undefined ? '':predicate.cscfga__Product_Definition__r.Name));
								$('#'+escapeId(lookupFieldDescInputId)+'_lkid').val(predicate.cscfga__Product_Definition__c);
							}
							//
							if (fieldLabel == 'Subject') {
								var lookupFieldDescInputId = $(this).next().find('.lookupInput').find('input').attr('Id'); 
								$('#'+escapeId(lookupFieldDescInputId)).val((predicate.cscfga__Subject__r.Name == undefined ? '':predicate.cscfga__Subject__r.Name));
								$('#'+escapeId(lookupFieldDescInputId)+'_lkid').val(predicate.cscfga__Subject__c);
							}
							if (fieldLabel == 'Value is expression') {
								if (predicate.cscfga__Value_is_expression__c) {
									$(this).next().find('input').prop('checked',true);
								} else {
									$(this).next().find('input').prop('checked',false);
								}
							}
							if (fieldLabel == 'Evaluate') $(this).next().find('select').val(predicate.cscfga__Evaluate__c);
							if (fieldLabel == 'Operator') $(this).next().find('select').val(predicate.cscfga__Operator__c);
							if (fieldLabel == 'Value') $(this).next().find('input').val(predicate.cscfga__Value__c);
						});
						//
					}
					$('.propertyInspector').unblock();
				}
				//
				function loadActionDetails(actionId,type) {
					//console.log('**actionId: ' + actionId);
					// highlight the selected rule
					$('.rule-li').css('background', '#BCE');
					$('#' + actionId).css('background', '#A4D48C');
					//$('#' + actionId).siblings().css('background', '#BCE');
					//
					blockScreenElement('.propertyInspector');
					// Display the relevant property Inspector: 
					$('.property-inspector').hide();
					var currentPropertyInspector = '#actionPropertyInspector-'+type;
					$(currentPropertyInspector).show();
					//
					Visualforce.remoting.Manager.invokeAction(
						'{!$RemoteAction.ProductDesignerController.loadActionDetails}',
						actionId, 
						handleLoadActionDetailsResponse,
						{escape: false}
					);
				}
				//
				function handleLoadActionDetailsResponse(result, event) {
					if (event.type == 'exception') {
						growlNow(event.message);
					} else {
						var actionDetails = result;
						var action = actionDetails.action;
						var attSelectOptionList = actionDetails.selectOptionList;
						var availableOptionList = action.cscfga__Available_Select_Option__r;
						//
						var actionMap = {"Execute JavaScript":"Javascript",
									  "Constrain List Values":"ConstrainValues",
									  "Display Info Message":"SetField",
									  "Set Billing Frequency":"SetField",
									  "Set Configuration Name":"SetField",
									  "Set Contract Term":"SetField",
									  "Set Contract Term Period":"SetField",
									  "Set Line Item Sequence":"SetField",
									  "Set Product Family":"SetField",
									  "Set Discount Type":"SetField",
									  "Set List Price":"SetField",
									  "Set Price":"SetField",
									  "Set Recurrence Frequency":"SetField",
									  "Set Value":"SetField",
									  "Set Value of Attribute Field":"SetField"};
						//
						var currentPropertyInspector = '#actionPropertyInspector-';
						if (action.cscfga__Product_Definition__c == undefined || actionMap[action.RecordType.Name] == 'Javascript') {
							//
							currentPropertyInspector += actionMap[action.RecordType.Name];
						} else {
							currentPropertyInspector += 'SetFieldProduct';
						}
						//
						console.log('Action RecordType: '+action.RecordType.Name);
						if (action.RecordType.Name == 'Constrain List Values') {
							$('#multi-select-div').children().remove();
							$('<select>').attr('multiple','multiple').attr('Id','attribute-select-options').appendTo('#multi-select-div');
							for (i = 0; i < attSelectOptionList.length; i++) {
								console.log('option: '+attSelectOptionList[i].Name);
								$('<option>').val(attSelectOptionList[i].Id).text(attSelectOptionList[i].Name).appendTo('#attribute-select-options');
							}
							$('#attribute-select-options').val(availableOptionList);
							$('#attribute-select-options').multiSelect({
				        		selectableHeader: "<div class='custom-header'><span style='margin-left: 10px;'>Available Options</span></div>",
				  				selectionHeader: "<div class='custom-header'><span style='margin-left: 10px;'>Selected Options</span></div>"
				        	});
				        	for (i = 0; i < (availableOptionList == undefined ? 0 : availableOptionList.length); i++) {
				        		console.log('availableOptionList[i].Id: '+availableOptionList[i].cscfga__Select_Option__c);
				        		$('#attribute-select-options').multiSelect('select',availableOptionList[i].cscfga__Select_Option__c);
				        	}
				        	//$('#attribute-select-options').multiSelect('select',["a0xE0000002RUlIIAW"]);
				        	$('.ms-container').css('background','transparent url("{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'switch.png')}") no-repeat 110px 80px');
				        }
			        	// set actionId
						$(currentPropertyInspector+' > table').find('.action-id').val(action.Id);
						//
						$(currentPropertyInspector+' > table').find('.field-label').each(function () {
							var fieldLabel = $.trim($(this).text());
							//
							console.log('fieldLabel: '+fieldLabel);
							if (fieldLabel == 'Number') $(this).next().find('span').html(action.Name);
							if (fieldLabel == 'Target Product') {
								var lookupFieldDescInputId = $(this).next().find('.lookupInput').find('input').attr('Id'); 
								$('#'+escapeId(lookupFieldDescInputId)).val((action.cscfga__Product_Definition__r == undefined ? '':action.cscfga__Product_Definition__r.Name));
								$('#'+escapeId(lookupFieldDescInputId)+'_lkid').val(action.cscfga__Product_Definition__c);
							}
							//
							if (fieldLabel == 'Target') {
								var lookupFieldDescInputId = $(this).next().find('.lookupInput').find('input').attr('Id'); 
								console.log(lookupFieldDescInputId);
								//
								$('#'+escapeId(lookupFieldDescInputId)).removeClass('readonly').css('display','inline').prop('readonly',false);
								$('#'+escapeId(lookupFieldDescInputId)).nextAll('.emptyDependentLookup').remove();
								//
								$('#'+escapeId(lookupFieldDescInputId)).val((action.cscfga__Target__r == undefined ? '':action.cscfga__Target__r.Name));
								$('#'+escapeId(lookupFieldDescInputId)+'_lkid').val(action.cscfga__Target__c);
								//
							}
							//
							if (fieldLabel == 'Attribute Field') {
								var lookupFieldDescInputId = $(this).next().find('.lookupInput').find('input').attr('Id'); 
								$('#'+escapeId(lookupFieldDescInputId)).val((cscfga__Attribute_Field__r == undefined ? '':action.cscfga__Attribute_Field__r.Name));
								$('#'+escapeId(lookupFieldDescInputId)+'_lkid').val(action.cscfga__Attribute_Field__c);
							}
							//
							if (fieldLabel == 'Value is expression') {
								if (action.cscfga__Value_is_expression__c) {
									$(this).next().find('input').prop('checked',true);
								} else {
									$(this).next().find('input').prop('checked',false);
								}
							}
							if (fieldLabel == 'JavaScript') $(this).next().find('textarea').val(action.cscfga__JavaScript__c);
							if (fieldLabel == 'Value') $(this).next().find('input').val(action.cscfga__Value__c);
						});
						//
					}
					$('.propertyInspector').unblock();
				}
				//
				function saveAction(button, actionId) {
					// Get action details
					var actionDetails = {};
					var action = {};
					action["Id"] = actionId;
					//
					var currentPropertyInspector = '#'+$(button).parent().parent().parent().parent().parent().attr('Id');
					console.log(currentPropertyInspector);
					console.log('actionId: '+actionId);
					console.log(button.parent().parent().parent().parent().parent().attr('Id'));
					//
					$(currentPropertyInspector+' > table').find('.field-label').each(function () {
						var fieldLabel = $.trim($(this).text());
						
						if (fieldLabel == 'Target Product') {
							var lookupFieldDescInputId = $(this).next().find('.lookupInput').find('input').attr('Id');
							action["cscfga__Product_Definition__c"] = $('#'+escapeId(lookupFieldDescInputId)+'_lkid').val();
						}
						if (fieldLabel == 'Target') {
							var lookupFieldDescInputId = $(this).next().find('.lookupInput').find('input').attr('Id');
							action["cscfga__Target__c"] = $('#'+escapeId(lookupFieldDescInputId)+'_lkid').val();
						}
						if (fieldLabel == 'Attribute Field') {
							var lookupFieldDescInputId = $(this).next().find('.lookupInput').find('input').attr('Id');
							action["cscfga__Attribute_Field__c"] = $('#'+escapeId(lookupFieldDescInputId)+'_lkid').val();
						}
						if (fieldLabel == 'Value is expression') {
							if ($(this).next().find('input').prop('checked')) {
								action["cscfga__Value_is_expression__c"] = true;
							} else {
								action["cscfga__Value_is_expression__c"] = false;
							}
						}
						if (fieldLabel == 'JavaScript') action["cscfga__JavaScript__c"] = $(this).next().find('textarea').val();
						if (fieldLabel == 'Value') action["cscfga__Value__c"] = $(this).next().find('input').val();
					});
					// de-highlight the selected element
					$('#' + action.Id).css('background', '#BCE');
					actionDetails.action = action;
					actionDetails.selectedOptionList = $('#attribute-select-options').val();
					console.log('actionDetails: '+JSON.stringify(actionDetails));
					//
					blockScreenElement('.propertyInspector');
					//
					Visualforce.remoting.Manager.invokeAction(
						'{!$RemoteAction.ProductDesignerController.saveAction}',
						JSON.stringify(actionDetails), 
						handleSaveActionResponse,
						{escape: false}
					);
				}
				//
				function handleSaveActionResponse(result, event) {
					if (event.type == 'exception') {
						growlNow(event.message);
					} else {
						growlNow('Action record saved successfully');
						//
						// Save rules sequencing and reload rules list
						saveRuleSequencing();
						//
						$('.propertyInspector').children().hide();
						$('.propertyInspector').unblock();
					}
				}
				//
				function savePredicate(button, predicateId) {
					// Get predicate details
					var predicate = {};
					predicate["Id"] = predicateId;
					//
					var currentPropertyInspector = '#'+$(button).parent().parent().parent().parent().parent().attr('Id');
					console.log(currentPropertyInspector);
					console.log('predicateId: '+predicateId);
					console.log(button.parent().parent().parent().parent().parent().attr('Id'));
					//
					$(currentPropertyInspector+' > table').find('.field-label').each(function () {
						var fieldLabel = $.trim($(this).text());
						
						if (fieldLabel == 'Product Definition') {
							var lookupFieldDescInputId = $(this).next().find('.lookupInput').find('input').attr('Id');
							predicate["cscfga__Product_Definition__c"] = $('#'+escapeId(lookupFieldDescInputId)+'_lkid').val();
						}
						if (fieldLabel == 'Subject') {
							var lookupFieldDescInputId = $(this).next().find('.lookupInput').find('input').attr('Id');
							predicate["cscfga__Subject__c"] = $('#'+escapeId(lookupFieldDescInputId)+'_lkid').val();
						}
						if (fieldLabel == 'Evaluate')  predicate["cscfga__Evaluate__c"] = $(this).next().find('select').val();
						if (fieldLabel == 'Operator') predicate["cscfga__Operator__c"] = $(this).next().find('select').val();
						if (fieldLabel == 'Value') predicate["cscfga__Value__c"] = $(this).next().find('input').val();
						if (fieldLabel == 'Value is expression') {
							if ($(this).next().find('input').prop('checked')) {
								predicate["cscfga__Value_is_expression__c"] = true;
							} else {
								predicate["cscfga__Value_is_expression__c"] = false;
							}
						}
					});
					// de-highlight the selected element
					$('#' + predicate.Id).css('background', '#BCE');
					
					console.log('actionDetails: '+JSON.stringify(predicate));
					//
					blockScreenElement('.propertyInspector');
					//
					Visualforce.remoting.Manager.invokeAction(
						'{!$RemoteAction.ProductDesignerController.savePredicate}',
						JSON.stringify(predicate), 
						handleSavePredicateResponse,
						{escape: false}
					);
				}
				//
				function handleSavePredicateResponse(result, event) {
					if (event.type == 'exception') {
						growlNow(event.message);
					} else {
						growlNow('Predicate record saved successfully');
						//
						// Save rules sequencing and reload rules list
						saveRuleSequencing();
						//
						$('.propertyInspector').children().hide();
						$('.propertyInspector').unblock();
					}
				}
				//
				function saveRule(button, ruleId) {
					// Get rule details
					var rule = {};
					rule["Id"] = ruleId;
					//
					var currentPropertyInspector = '#'+$(button).parent().parent().parent().parent().parent().attr('Id');
					console.log(currentPropertyInspector);
					console.log(ruleId);
					console.log(button.parent().parent().parent().parent().parent().attr('Id'));
					//
					$(currentPropertyInspector+' > table').find('.field-label').each(function () {
						var fieldLabel = $.trim($(this).text());
						if (fieldLabel == 'Grouping') rule["cscfga__Grouping__c"] = $(this).next().find('input').val();
						if (fieldLabel == 'Logic') rule["cscfga__Logic__c"] = $(this).next().find('input').val();
						if (fieldLabel == 'Active') {
							if ($(this).next().find('input').prop('checked')) {
								rule["cscfga__Active__c"] = true;
							} else {
								rule["cscfga__Active__c"] = false;
							}
						}
					});
					console.log('rule: '+JSON.stringify(rule));
					// de-highlight the selected element
					$('#' + rule.Id).css('background', '#BCE');
					//
					blockScreenElement('.propertyInspector');
					//
					Visualforce.remoting.Manager.invokeAction(
						'{!$RemoteAction.ProductDesignerController.saveRule}',
						JSON.stringify(rule), 
						handleSaveRuleResponse,
						{escape: false}
					);
				}
				//
				function handleSaveRuleResponse(result, event) {
					if (event.type == 'exception') {
						growlNow(event.message);
					} else {
						growlNow('Rule record saved successfully');
						//
						// Save rules sequencing and reload rules list
						saveRuleSequencing();
						//
						$('.propertyInspector').children().hide();
						$('.propertyInspector').unblock();
					}
				}
				//
				function saveRuleSequencing() {
					blockScreenElement('#centerColumn');
					//
					var ruleSequenceString = '';
					var SelectedRulePredicateSequenceString = '';
					var SelectedRuleNormalActionSequenceString = '';
					var SelectedRuleElseActionSequenceString = '';
					var selectedRuleId = ($('#rulePropertyInspectorId > table').find('#rule-id').val() == undefined ? '' : $('#rulePropertyInspectorId > table').find('#rule-id').val());
					//
					var i = 0;
					$('#rule-div > li').each(function () {
						ruleSequenceString += $(this).attr('valueId');
						console.log('$(this).attr(\'valueId\'): '+$(this).attr('valueId'));
						i++;
						if (i < $('#rule-div > li').size()) ruleSequenceString += ':';
					});
					console.log('ruleSequenceString: '+ruleSequenceString);
					//
					console.log('selectedRuleId **: '+selectedRuleId);
					if (selectedRuleId != undefined) {
						i = 0;
						$('#predicate-div > li').each(function () {
							SelectedRulePredicateSequenceString += $(this).attr('Id');
							i++;
							if (i < $('#predicate-div > li').size()) SelectedRulePredicateSequenceString += ':';
						});
						//console.log(SelectedRulePredicateSequenceString);
						//
						i = 0;
						$('#action-normal-div > li').each(function () {
							SelectedRuleNormalActionSequenceString += $(this).attr('Id');
							i++;
							if (i < $('#action-normal-div > li').size()) SelectedRuleNormalActionSequenceString += ':';
						});
						//console.log(SelectedRuleNormalActionSequenceString);
						//
						i = 0;
						$('#action-else-div > li').each(function () {
							SelectedRuleElseActionSequenceString += $(this).attr('Id');
							i++;
							if (i < $('#action-else-div > li').size()) SelectedRuleElseActionSequenceString += ':';
						});
						//console.log(SelectedRuleElseActionSequenceString);
					}
					//
					if (selectedRuleId != '' && SelectedRulePredicateSequenceString == '' && SelectedRuleNormalActionSequenceString == '' && SelectedRuleElseActionSequenceString == '') {
						var checkstr = confirm('Are you sure you want to save the selected rule "'+$('#rule-id').parent().parent().parent().find('span').text()+'" without associations?');
						if (checkstr == true) {
							Visualforce.remoting.Manager.invokeAction(
								'{!$RemoteAction.ProductDesignerController.saveRuleSequencing}',
								'{!cscfga__Product_Definition__c.Id}',
								selectedRuleId,
								ruleSequenceString,
					   			SelectedRulePredicateSequenceString,
					   			SelectedRuleNormalActionSequenceString,
					   			SelectedRuleElseActionSequenceString, 
					   			handleSaveRuleSequencingResponse,
								{escape: false}
							);
						} else {
							growlNow('Cancelled rule sequencing');
							//
							$('#centerColumn').unblock();
							return false;
						}
					} else {
						Visualforce.remoting.Manager.invokeAction(
							'{!$RemoteAction.ProductDesignerController.saveRuleSequencing}',
							'{!cscfga__Product_Definition__c.Id}',
							selectedRuleId,
							ruleSequenceString,
				   			SelectedRulePredicateSequenceString,
				   			SelectedRuleNormalActionSequenceString,
				   			SelectedRuleElseActionSequenceString, 
				   			handleSaveRuleSequencingResponse,
							{escape: false}
						);
					}
				}
				//
				function handleSaveRuleSequencingResponse(result, event) {
					if (event.type == 'exception') {
						growlNow(event.message);
					} else {
						growlNow('Rule sequencing saved successfully');
						//
						$('#rulePropertyInspectorId').hide();
						// Reload rules list
						loadRuleList('{!cscfga__Product_Definition__c.Id}');
						//
						$('#centerColumn').unblock();
					}
				}
		    	//
				function addRule(productDefinitionId) {
					Visualforce.remoting.Manager.invokeAction(
						'{!$RemoteAction.ProductDesignerController.addRule}',
						productDefinitionId, 
						handleAddRuleResponse,
						{escape: false}
					);
				}
				//
				function handleAddRuleResponse(result, event) {
					if (event.type == 'exception') {
						growlNow(event.message);
					} else {
						newRule = result;
						createdRuleId = newRule.Id;
						growlNow('Rule "'+newRule.Name+'" created successfully');
						saveRuleSequencing();
					}
				}
				//
				function toggleRule(ruleId) {
					blockScreenElement('#rules-screen');
					//$('.rule-id').val('');
					//
					Visualforce.remoting.Manager.invokeAction(
						'{!$RemoteAction.ProductDesignerController.toggleRule}',
						ruleId, 
						handleToggleRuleResponse,
						{escape: false}
					);
				}
				//
				function handleToggleRuleResponse(result, event) {
					if (event.type == 'exception') {
						growlNow(event.message);
					} else {
						growlNow('Rule set to "'+result+'" successfully');
						//
						// Save rule sequencing and reload rules list
						saveRuleSequencing();
						$('.rule-id').val('');
						//
						$('#centerColumn').unblock();
					}
				}
				//
				function loadAttributeRuleComponentList(productDefinitionId) {
					blockScreenElement('#leftColumn');
					//
					Visualforce.remoting.Manager.invokeAction(
						'{!$RemoteAction.ProductDesignerController.getAttributeRuleComponents}',
						productDefinitionId, 
						handleLoadAttributeRuleComponentsResponse,
						{escape: false}
					);
				}
				//
				function handleLoadAttributeRuleComponentsResponse(result, event) {
					if (event.type == 'exception') {
						growlNow(event.message);
					} else {
						//
						var actionMap = {"Execute JavaScript":"Javascript",
									  "Constrain List Values":"ConstrainValues",
									  "Display Info Message":"SetField",
									  "Set Billing Frequency":"SetField",
									  "Set Configuration Name":"SetField",
									  "Set Contract Term":"SetField",
									  "Set Contract Term Period":"SetField",
									  "Set Line Item Sequence":"SetField",
									  "Set Product Family":"SetField",
									  "Set Discount Type":"SetField",
									  "Set List Price":"SetField",
									  "Set Price":"SetField",
									  "Set Recurrence Frequency":"SetField",
									  "Set Value":"SetField",
									  "Set Value of Attribute Field":"SetField"};
						//
						var attributeList = result;
						var attRuleComponentDiv = '';
						var productRuleComponentDiv = '';
						
						for (i = 0; i < (attributeList == undefined ? 0 : attributeList.length); i++) {
							var attribute = attributeList[i];
							//
							attRuleComponentDiv += '<ul class="rule-components" id="attribute-rule-components">'
							attRuleComponentDiv += '<li style="display: block; margin-left: 0px;padding-left: 10px;">';
							attRuleComponentDiv += '    <img class="hierarchy-image" title="Expand" src="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'expand.png')}" id="expand-'+attribute.id+'" onClick="toggleRuleComponentsDetails(this,\''+attribute.Id+'\')"/>';
							attRuleComponentDiv += attribute.Name.substring(0,{!$Setup.cspduia__Product_Designer_Options__c.cspduia__Attribute_Name_Display_Length__c});
							attRuleComponentDiv += '    <img class="action-image" title="Add predicate" src="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'add-predicate-12.png')}" id="setupIcon-'+attribute.Id+'" onClick="addPredicateLayer(\''+attribute.Id+'\',\'Attribute\',\'PredicateAttribute\');"/>';
							attRuleComponentDiv += '    <img class="action-image" title="Add action" src="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'add-action-12.png')}" id="setupIcon-'+attribute.Id+'" onClick="callAddAction(\''+attribute.Id+'\',$(this).position().top);"/>';
							//
							attRuleComponentDiv += getAttributeActionMenu(attribute.Id,'Attribute');
							//
							attRuleComponentDiv += '    <ul class="single-col-rule-div" id="predicate-action-div-'+attribute.Id+'">';
							//
							var actionList = attribute.cscfga__Actions__r;
							var predicateList = attribute.cscfga__Predicates__r;
							//
							for (k = 0; k < (predicateList == undefined ? 0 : predicateList.length); k++) {
								var predicate = predicateList[k]; 
								attRuleComponentDiv += '<li class="rule-li" id="'+predicate.Id+'" type="predicate" title="'+predicate.cscfga__Label__c+'">';
								attRuleComponentDiv += '    <b class="handle">'+predicate.Name+':</b> '+predicate.cscfga__Label__c.substring(0,{!$Setup.cspduia__Product_Designer_Options__c.cspduia__Predicate_Label_Display_Length__c});
								attRuleComponentDiv += '    <img class="setup-image" title="Predicate settings" src="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'edit-settings-12.png')}" id="setupIcon-'+predicate.Id+'" onClick="loadPredicateDetails(\''+predicate.Id+'\',\'attribute\')"/>';
								attRuleComponentDiv += '    <img class="delete-image" title="Delete Predicate" src="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'delete-12.png')}" onClick="deletePredicate(\''+predicate.Id+'\',\''+predicate.Name+'\');"/>';
								attRuleComponentDiv += '</li>';
							}
							//
							for (j = 0; j < (actionList == undefined ? 0 : actionList.length); j++) {
								var action = actionList[j]; 
								//console.log('actionList Key: '+action.RecordType.Name+' - Value :'+actionMap[action.RecordType.Name]);
								attRuleComponentDiv += '<li class="rule-li" id="'+action.Id+'" type="action" title="'+action.cscfga__Label__c+'">';
								attRuleComponentDiv += '    <b class="handle">'+action.Name+':</b> '+action.cscfga__Label__c.substring(0,{!$Setup.cspduia__Product_Designer_Options__c.cspduia__Action_Label_Display_Length__c});
								if (actionMap[action.RecordType.Name] != undefined) 
									attRuleComponentDiv += '    <img class="setup-image" title="Action settings" src="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'edit-settings-12.png')}" id="setupIcon-'+action.Id+'" onClick="loadActionDetails(\''+action.Id+'\',\''+actionMap[action.RecordType.Name]+'\')"/>';
								attRuleComponentDiv += '    <img class="delete-image" title="Delete Action" src="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'delete-12.png')}" onClick="deleteAction(\''+action.Id+'\',\''+action.Name+'\');"/>';
								attRuleComponentDiv += '</li>';
							}
							attRuleComponentDiv += '	</ul>';
							
							attRuleComponentDiv += '</li>';
							attRuleComponentDiv += '</ul>';
						}
						//
						//console.log(attRuleComponentDiv);
						$('#rule-components-fieldset').children('ul').remove();
						$('#rule-components-fieldset').append(attRuleComponentDiv);
					}
					loadProductRuleComponentList('{!cscfga__Product_Definition__c.Id}');
				}
		    	//
				function loadProductRuleComponentList(productDefinitionId) {
					Visualforce.remoting.Manager.invokeAction(
						'{!$RemoteAction.ProductDesignerController.getProductRuleComponents}',
						productDefinitionId, 
						handleLoadProductRuleComponentsResponse,
						{escape: false}
					);
				}
				//
				function handleLoadProductRuleComponentsResponse(result, event) {
					if (event.type == 'exception') {
						growlNow(event.message);
					} else {
						//
						var actionMap = {"Execute JavaScript":"Javascript",
									  "Constrain List Values":"ConstrainValues",
									  "Display Info Message":"SetField",
									  "Set Billing Frequency":"SetField",
									  "Set Configuration Name":"SetField",
									  "Set Contract Term":"SetField",
									  "Set Contract Term Period":"SetField",
									  "Set Line Item Sequence":"SetField",
									  "Set Product Family":"SetField",
									  "Set Discount Type":"SetField",
									  "Set List Price":"SetField",
									  "Set Price":"SetField",
									  "Set Recurrence Frequency":"SetField",
									  "Set Value":"SetField",
									  "Set Value of Attribute Field":"SetField"};
						//
						var productList = result;
						var productRuleComponentDiv = '';
						
						for (i = 0; i < (productList == undefined ? 0 : productList.length); i++) {
							var product = productList[i];
							//
							productRuleComponentDiv += '<ul class="rule-components" id="product-rule-components">'
							productRuleComponentDiv += '<li style="display: block; margin-left: 0px;padding-left: 10px;">';
							productRuleComponentDiv += '    <img class="hierarchy-image" title="Expand" src="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'expand.png')}" id="expand-'+product.id+'" onClick="toggleRuleComponentsDetails(this,\''+product.Id+'\')"/>';
							productRuleComponentDiv += '<b>Product:</b> '+product.Name;
							productRuleComponentDiv += '    <img class="action-image" title="Add predicate" src="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'add-predicate-12.png')}" id="setupIcon-'+product.Id+'" onClick="addPredicateLayer(\''+product.Id+'\',\'Product\',\'PredicateProduct\');"/>';
							productRuleComponentDiv += '    <img class="action-image" title="Add action" src="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'add-action-12.png')}" id="setupIcon-'+product.Id+'" onClick="$(\'#add-action-ul-'+product.Id+'\').slideToggle(50).css(\'display\',\'inline-block\').css(\'top\',$(this).position().top);event.stopPropagation();"/>';
							//
							productRuleComponentDiv += getProductActionMenu('{!cscfga__Product_Definition__c.id}','Product');
							//
							productRuleComponentDiv += '    <ul class="single-col-rule-div" id="predicate-action-div-'+product.Id+'">';
							//
							var actionList = product.cscfga__Actions__r;
							var predicateList = product.cscfga__PredicateDefinition__r;
							//
							for (k = 0; k < (predicateList == undefined ? 0 : predicateList.length); k++) {
								var predicate = predicateList[k]; 
								productRuleComponentDiv += '<li class="rule-li" id="'+predicate.Id+'" type="predicate" title="'+predicate.cscfga__Label__c+'">';
								productRuleComponentDiv += '    <b class="handle">'+predicate.Name+':</b> '+predicate.cscfga__Label__c.substring(0,{!$Setup.cspduia__Product_Designer_Options__c.cspduia__Predicate_Label_Display_Length__c});
								productRuleComponentDiv += '    <img class="setup-image" title="Predicate settings" src="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'edit-settings-12.png')}" id="setupIcon-'+predicate.Id+'" onClick="loadPredicateDetailsJs(\''+predicate.Id+'\',\'product\')"/>';
								productRuleComponentDiv += '    <img class="delete-image" title="Delete Predicate" src="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'delete-12.png')}" onClick="deletePredicate(\''+predicate.Id+'\',\''+predicate.Name+'\');"/>';
								productRuleComponentDiv += '</li>';
							}
							//
							for (j = 0; j < (actionList == undefined ? 0 : actionList.length); j++) {
								var action = actionList[j]; 
								productRuleComponentDiv += '<li class="rule-li" id="'+action.Id+'" type="action" title="'+action.cscfga__Label__c+'">';
								productRuleComponentDiv += '    <b class="handle">'+action.Name+':</b> '+action.cscfga__Label__c.substring(0,{!$Setup.cspduia__Product_Designer_Options__c.cspduia__Action_Label_Display_Length__c});
								console.log('actionMap[action.RecordType.Name]: '+actionMap[action.RecordType.Name]);
								if (actionMap[action.RecordType.Name] != undefined && actionMap[action.RecordType.Name] == 'Javascript') {
									productRuleComponentDiv += '    <img class="setup-image" title="Action settings" src="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'edit-settings-12.png')}" id="setupIcon-'+action.Id+'" onClick="loadActionDetails(\''+action.Id+'\',\''+actionMap[action.RecordType.Name]+'\')"/>';
								} else {
									productRuleComponentDiv += '    <img class="setup-image" title="Action settings" src="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'edit-settings-12.png')}" id="setupIcon-'+action.Id+'" onClick="loadActionDetails(\''+action.Id+'\',\'SetFieldProduct\')"/>';
								}
								productRuleComponentDiv += '    <img class="delete-image" title="Delete Action" src="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'delete-12.png')}" onClick="deleteAction(\''+action.Id+'\',\''+action.Name+'\');"/>';
								productRuleComponentDiv += '</li>';
							}
							productRuleComponentDiv += '	</ul>';
							
							productRuleComponentDiv += '</li>';
							productRuleComponentDiv += '</ul>';
						}
						//
						//console.log(productRuleComponentDiv);
						$('#rule-components-fieldset').append(productRuleComponentDiv);
					}
					console.log('selectedMasterRelationshipId: '+selectedMasterRelationshipId);
					if (selectedMasterRelationshipId != '')
						openRuleComponentsDetails($('#expand-'+selectedMasterRelationshipId),selectedMasterRelationshipId);
					//
					makeRulesSortable();
					//
					$('#leftColumn').unblock();
				}
				//
				function callAddAction(attributeId,currentTopPosition) {
					console.log('currentTopPosition: '+currentTopPosition);
					var offset = 0;
					if (currentTopPosition >= 200) offset = 150;
					if (currentTopPosition >= 300) offset = 250;
					if (currentTopPosition >= 400) offset = 350;
					$('#add-action-ul-'+attributeId).slideToggle(50).css('display','inline-block').css('top',currentTopPosition - offset);
					event.stopPropagation();
				}
				//
				function getAttributeActionMenu(masterRelationshipId,masterRelationshipName) {
					var actionList = {"Add attribute to Line items":['addSingleClickAction',''],
									  "Disable Attribute":['addSingleClickAction',''],
									  "Make Attribute Mandatory":['addSingleClickAction',''],
									  "Make Attribute Optional":['addSingleClickAction',''],
									  "Make Attribute Read-Only":['addSingleClickAction',''],
									  "Mark Configuration Invalid":['addActionLayer','SetField'],
									  "Remove Attribute from Line Items":['addSingleClickAction',''],
									  "Constrain List Values":['addActionLayer','ConstrainValues'],
									  "Require Data Refresh":['addSingleClickAction',''],
									  "Set Billing Frequency":['addActionLayer','SetField'],
									  "Set Configuration Name":['addActionLayer','SetField'],
									  "Set Contract Term":['addActionLayer','SetField'],
									  "Set Contract Term Period":['addActionLayer','SetField'],
									  "Set Line Item Sequence":['addActionLayer','SetField'],
									  "Set Product Family":['addActionLayer','SetField'],
									  "Set Discount Type":['addActionLayer','SetField'],
									  "Set List Price":['addActionLayer','SetField'],
									  "Set Price":['addActionLayer','SetField'],
									  "Set Recurrence Frequency":['addActionLayer','SetField'],
									  "Set Value":['addActionLayer','SetField'],
									  "Set Value of Attribute Field":['addActionLayer','SetAttributeField']};
					var actionMenu = '';
					actionMenu += '<script>';
					actionMenu += '	$(\'body\').click(function (event) {';
					actionMenu += '		event.stopPropagation();';
					actionMenu += '		if ($(\'#add-action-ul-'+masterRelationshipId+'\').is(":visible")) {';
				    actionMenu += '        	$(\'#add-action-ul-'+masterRelationshipId+'\').slideUp(50);';
				    actionMenu += '     }';
				    actionMenu += ' });';
					actionMenu += '<\/script>';
					actionMenu += '<ul class="action-options" id="add-action-ul-'+masterRelationshipId+'" >';
					$.each(actionList, function(i, item) {
						//console.log(i+':'+item[0]);
						if (item[0] == 'addSingleClickAction') {
            				actionMenu += '<li class="action-option" onClick="'+item[0]+'(\''+masterRelationshipId+'\',$(this).find(\'a\').find(\'label\').text(),\''+masterRelationshipName+'\');">';
            			} else {
            				actionMenu += '<li class="action-option" onClick="'+item[0]+'(\''+item[1]+'\',\''+masterRelationshipId+'\',$(this).find(\'a\').find(\'label\').text(),\''+masterRelationshipName+'\');">';
            			}
            			actionMenu += '	<a>';
						actionMenu += '		<img  class="action-item-image" src="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'add-attribute-24.png')}"></img>';
						actionMenu += '		<label>'+i+'</label>';
						actionMenu += '	</a>';
						actionMenu += '</li>';
            			
        			});
        			actionMenu += '</ul>';
        			//console.log(actionMenu);
        			return actionMenu;
				}
				//
				function getProductActionMenu(masterRelationshipId,masterRelationshipName) {
					var actionList = {"Execute JavaScript":['addActionLayer','Javascript'],
									  "Display Info Message":['addActionLayer','SetFieldProduct'],
									  "Mark Configuration Invalid":['addActionLayer','SetFieldProduct'],
									  "Require Data Refresh":['addSingleClickAction','SetFieldProduct'],
									  "Set Billing Frequency":['addActionLayer','SetFieldProduct'],
									  "Set Configuration Name":['addActionLayer','SetFieldProduct'],
									  "Set Product Family":['addActionLayer','SetFieldProduct'],
									  "Set Contract Term":['addActionLayer','SetFieldProduct'],
									  "Set Contract Term Period":['addActionLayer','SetFieldProduct']};
					var actionMenu = '';
					actionMenu += '<script>';
					actionMenu += '	$(\'body\').click(function (event) {';
					actionMenu += '		event.stopPropagation();';
					actionMenu += '		if ($(\'#add-action-ul-'+masterRelationshipId+'\').is(":visible")) {';
				    actionMenu += '        	$(\'#add-action-ul-'+masterRelationshipId+'\').slideUp(50);';
				    actionMenu += '     }';
				    actionMenu += ' });';
					actionMenu += '<\/script>';
					actionMenu += '<ul class="action-options" id="add-action-ul-'+masterRelationshipId+'">';
					$.each(actionList, function(i, item) {
						//console.log(i+':'+item);
						if (item[0] == 'addSingleClickAction') {
            				actionMenu += '<li class="action-option" onClick="'+item+'(\''+masterRelationshipId+'\',$(this).find(\'a\').find(\'label\').text(),\''+masterRelationshipName+'\');">';
            			} else {
            				actionMenu += '<li class="action-option" onClick="'+item[0]+'(\''+item[1]+'\',\''+masterRelationshipId+'\',$(this).find(\'a\').find(\'label\').text(),\''+masterRelationshipName+'\');">';
            			}
            			actionMenu += '	<a>';
						actionMenu += '		<img  class="action-item-image" src="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'add-attribute-24.png')}"></img>';
						actionMenu += '		<label>'+i+'</label>';
						actionMenu += '	</a>';
						actionMenu += '</li>';
            			
        			});
        			actionMenu += '</ul>';
        			//console.log(actionMenu);
        			return actionMenu;
				}
		    	//
				function addSingleClickAction(masterRelationshipId,actionType,masterRelationshipName) {
					Visualforce.remoting.Manager.invokeAction(
						'{!$RemoteAction.ProductDesignerController.addSingleClickAction}',
						masterRelationshipId,
						actionType,
						masterRelationshipName, 
						handleAddSingleClickActionResponse,
						{escape: false}
					);
				}
				//
				function handleAddSingleClickActionResponse(result, event) {
					if (event.type == 'exception') {
						growlNow(event.message);
					} else {
						selectedMasterRelationshipId = result;
						loadAttributeRuleComponentList('{!cscfga__Product_Definition__c.Id}');
					}
				}
				//
				function addAttributeLayer(attributeType) {
					var iFrame =
						'<iframe id="overlayIframe" src="/apex/AddAttributeDefinition?id={!cscfga__Product_Definition__c.Id}&AttDefType=' +
						attributeType + '"></iframe>';
					showProgress(iFrame, '');
					$("#processing_overlay").click(function () {
						hideProgress();
						$('#Add-Attribute-Select').ddslick('select', {
							index: 0
						});
					});
				}
				//
				function addScreenLayer() {
					var iFrame =
						'<iframe id="overlayIframe" src="/apex/AddScreen?id={!cscfga__Product_Definition__c.Id}"></iframe>';
					showProgress(iFrame, '');
					$("#processing_overlay").click(function () {
						hideProgress();
					});
				}
				//
				function addSectionLayer() {
					var iFrame =
						'<iframe id="overlayIframe" src="/apex/AddSection?id={!cscfga__Product_Definition__c.Id}"></iframe>';
					showProgress(iFrame, '');
					$("#processing_overlay").click(function () {
						hideProgress();
					});
				}
				//
				function addActionLayer(fieldSet,masterRelationshipId,actionType,masterRelationshipName) {
					var iFrame =
						'<iframe id="overlayIframe" src="/apex/AddAction?id={!cscfga__Product_Definition__c.Id}&fieldSet='+fieldSet+'&masterRelationshipId='+masterRelationshipId+'&masterRelationshipName='+masterRelationshipName+'&actionType='+actionType+'"></iframe>';
					showProgress(iFrame, '');
					$("#processing_overlay").click(function () {
						hideProgress();
					});
				}
				//
				function addPredicateLayer(masterRelationshipId,masterRelationshipName,fieldSet) {
					var iFrame =
						'<iframe id="overlayIframe" src="/apex/AddPredicate?id={!cscfga__Product_Definition__c.Id}&fieldSet='+fieldSet+'&masterRelationshipId='+masterRelationshipId+'&masterRelationshipName='+masterRelationshipName+'"></iframe>';
					showProgress(iFrame, '');
					$("#processing_overlay").click(function () {
						hideProgress();
					});
				}
				//
				function initialisePage() {
					
					blockScreenElement('.outer');
					// unblock when ajax activity stops 
					$(document).ajaxStop($.unblockUI);
					//
					// Get the list of screens
					loadScreenList('{!cscfga__Product_Definition__c.Id}');
					// Get Off Screen Attributes
					getOffScreenAttributes('{!cscfga__Product_Definition__c.Id}');
					// Get On Screen Attributes
					getOnScreenAttributes('{!cscfga__Product_Definition__c.Id}');
					//
					// Create an object to store attribute images
					var attributeImage = {
						"Calculation": "{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'calculation-20.png')}",
						"Checkbox": "{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'checkbox-20.png')}",
						"Date": "{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'date-20.png')}",
						"Lookup": "{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'lookup-20.png')}",
						"Radio Button": "{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'radio-20.png')}",
						"Related Product": "{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'related-product-20.png')}",
						"Select List": "{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'select-list-20.png')}",
						"Text Display": "{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'text-display-20.png')}",
						"User Input": "{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'user-input-20.png')}",
						"Spacer": "{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'spacer-20.png')}"
					};
					//
					var expressionOptions;
					getExpressionOptions();
					//
					
					$('#unusedComponentsTable').find('.toggle-image').hide();
					
					initialiseDragDrop();
					//
					selectedMasterRelationshipId = '';
					if (!window._csMsgListener) {
						window._csMsgListener = true;
						// set up a handler to receive messages from the Fees frame
						jQuery(window).bind('message', function (e) {
							var msg = jQuery.parseJSON(e.originalEvent.data);
							var action = msg.action;
							selectedScreenId = msg.screenId;
							var productName = msg.productName;
							var attachName = msg.attachName;
							//console.log('msg.screenId: '+msg.screenId);
							if (action == 'AttributeCreated') {
								hideProgress();
								//
								blockScreenElement('#unusedComponentsTable');
								//
								getOffScreenAttributes('{!cscfga__Product_Definition__c.Id}');
								//
							} else if (action == 'upLoadDone') {
								hideProgress();
								//
								blockScreenElement('.outer');
								//
								getOffScreenAttributes('{!cscfga__Product_Definition__c.Id}');
							} else if (action == 'SectionCreated') {
								hideProgress();
								//
								blockScreenElement('.outer');
								//
								getOnScreenAttributes('{!cscfga__Product_Definition__c.Id}');
							} else if (action == 'ScreenCreated') {
								hideProgress();
								//
								blockScreenElement('.outer');
								// Get the list of screens
								loadScreenList('{!cscfga__Product_Definition__c.Id}');
								//
								getOnScreenAttributes('{!cscfga__Product_Definition__c.Id}');
							} else if (action == 'ActionCreated') {
								hideProgress();
								//
								//blockScreenElement('#ruleComponents');
								//
								selectedMasterRelationshipId = msg.selectedMasterRelationshipId;
								console.log('Created Action for: '+selectedMasterRelationshipId);
								loadAttributeRuleComponentList('{!cscfga__Product_Definition__c.Id}');
							} else if (action == 'PredicateCreated') {
								hideProgress();
								//
								//blockScreenElement('#ruleComponents');
								//
								selectedMasterRelationshipId = msg.selectedMasterRelationshipId;
								loadAttributeRuleComponentList('{!cscfga__Product_Definition__c.Id}');
							} else if (action == 'CloneAttributeDone') {
								hideProgress();
								//
								blockScreenElement('.outer');
								//
								getOffScreenAttributes('{!cscfga__Product_Definition__c.Id}');
								//
								$('#ruleComponents').parent().hide();
								growlNow('Attributes copied from product "'+productName+'"');
							} else if (action == 'ExportAttributeDone') {
								hideProgress();
								//
								growlNow('Attributes exported from product "'+productName+'" and stored as attachment "'+attachName+'"');
							} else if (action == 'CloseWindow') {
								hideProgress();
							} 
						});
					}
					//
					$('document').ready(function () {
						$('.attributeDiv').each(function () {
							$(this).find('.label-image').attr('src', attributeImage[$(this)
								.attr('value')]);
							$(this).find('.label-image').attr('title', $(this).attr('value'));
						});
				
						$('.spacerDiv').each(function () {
							$(this).find('.label-image').attr('src', attributeImage[$(this)
								.attr('value')]);
							$(this).find('.label-image').attr('title', $(this).attr('value'));
						});
						//
						$('.outer').unblock();
					});
					//
					// Loop through the screen divs and hide all of them except for the first in the list
					$('.screen').hide();
					//console.log('***<<selectedScreenId:' + selectedScreenId);
					selectScreen(selectedScreenId);
					//
					makeScreenSelectListSlick();
					makeAttributeSelectListSlick();
					//
					$('document').ready(function () {
						initialiseDragDrop();
						makeRulesSortable();
					});
					//
					initialiseExpressionEnabledFields();
					//
					$('.property-inspector').hide();
					//
				}
				//
				function initialiseExpressionEnabledFields() {
					//
					$.widget( "custom.catcomplete", $.ui.autocomplete, {
					    _renderMenu: function( ul, items ) {
					      var that = this,
					        currentCategory = "";
					      $.each( items, function( index, item ) {
					        if ( item.category != currentCategory ) {
					          ul.append( "<li class='ui-autocomplete-category'>" + item.category + "</li>" );
					          currentCategory = item.category;
					        }
					        that._renderItemData( ul, item );
					      });
					    }
					});
					//
	                $(function() {
						//
						function split(val) {
							return val.split(/,\s*/);
						}
						
						function extractLast(term) {
							return split(term).pop();
						}
						//
						$('.accept-expression')
							.bind("keydown", function (event) {
								// don't navigate away from the field on tab when selecting an item
								if (event.keyCode === $.ui.keyCode.TAB &&
									$(this).data("ui-autocomplete").menu.active) {
									event.preventDefault();
								}
							})
							.catcomplete({
						        minLength: 1,
						        source: function( request, response ) {
						          // delegate back to autocomplete, but extract the last term
						          //console.log('***'+request.term);
						          if (request.term.match('{')) {
						            //console.log('>>>'+request.term);
						            var searchTerm = request.term.substring(request.term.lastIndexOf('{')+1);
						            response( $.ui.autocomplete.filter(
						              expressionOptions, searchTerm ) );
						          }
						        },
						        focus: function() {
						          // prevent value inserted on focus
						          return false;
						        },
						        select: function( event, ui ) {
						          //var terms = split( this.value );
						          //console.log(this.value);
						          // remove the search term from the string:
						          var searchTerm = this.value.substring(this.value.lastIndexOf('{')+1);
						          //console.log('>>--'+searchTerm);
						          var currentValue = this.value.replace(this.value.substring(this.value.lastIndexOf('{')+1),'');
						          //
						          var newExpression = ui.item.value;
						          if (newExpression.match('^Lookup') || newExpression.match('^Linked') || newExpression.match('^Config') || newExpression.match('^Parent') || newExpression.match('^Context')) newExpression = '$'+newExpression;
						          this.value = currentValue+''+newExpression+'}';
						          return false;
						        },
						        open: function(event, ui) {
									// Remove accessibility helper
									$('.ui-helper-hidden-accessible').css('display','none');
						        }
							});
	            	});
				}
				//
				function makeScreenSelectListSlick() {
					$('#Screen-Select').ddslick({
						onSelected: function (data) {
							//console.log('*** Selecting a new Screen. Current screen is: ' + selectedScreenId);
							//console.log('>>>>>data.selectedData: '+data.selectedData);
							$('#' + selectedScreenId).hide();
							if (data.selectedData != undefined) {
								$('.screen').hide();
								//console.log('>>--->>>'+data.selectedData.value);
								$('#' + data.selectedData.value).show("slide", {
									direction: "left"
								}, 300);
								$('#' + data.selectedData.value).siblings().hide();
								selectedScreenId = data.selectedData.value;
								//console.log('***>>selectedScreenId:' + selectedScreenId);
								//
								if (data.selectedData.value == 'rules-screen') {
									$('#unusedComponentsTable').hide();
									$('#ruleComponents').show();
								} else {
									$('#unusedComponentsTable').show();
									$('#ruleComponents').hide();
								}
								}
								//
						}
					});
				}
				//
				function makeAttributeSelectListSlick() {
					$('#Add-Attribute-Select').ddslick({
						onSelected: function (data) {
							//console.log(data.selectedData.value);
							if (data.selectedData.value != '-1' && data.selectedData.value != 'Spacer') {
								addAttributeLayer(data.selectedData.value);
							} else if (data.selectedData.value == 'Spacer') {
								addSpacer();
							}
						}
					});
				}
				//
				function blockScreenElement(elementSelector) {
					$(elementSelector).block({
						message: '<div style="width:300px;height:300px"></div>',
						css: {
							border: '0px solid #A4D48C',
							background: 'url("{!URLFOR($Resource.ProductDefinitionBuilderIcons, "ProgressWheel.gif")}") 50% 50% no-repeat',
							cursor: 'default'
						},
						overlayCSS: {
							backgroundColor: '#ccc',
							opacity: 0.6,
							cursor: 'default'
						},
					});
				} 
				//
				function growlNow(message) {
					$.jGrowl('<table class="growl"><tr><td><img src="{!URLFOR($Resource.ProductDefinitionBuilderIcons, "Info.png")}"></td><td>'+message+'</td></tr></table>');
				}
				//
				function selectScreen(screenId) {
					//
					console.log('>> Entering select screen');
					// 
					var i = 0;
					var firstScreenId = $('#screens > .screen').first().attr('Id');
					$('#screens > .screen').hide();
					console.log('**:'+$('#screens > .screen').first().attr('Id'));
					//
					i = 0;
					var screenFound = false;
					console.log('***<<Setting Screen Id to:' + screenId);
					if (screenId != '') {
						$('#screens > .screen').each(function () {
							if ($(this).attr('Id') == screenId) {
								//console.log('i is:'+i);
								$('#Screen-Select').ddslick('select',{index: i});
								screenFound = true;
							} 
							i++;
						});
						//
						if (!screenFound) {
							$('#Screen-Select').ddslick('select',{index: 0});
							$('#'+firstScreenId).show();
							$('#'+firstScreenId).siblings().hide();
							selectedScreenId = firstScreenId;
						} else {
							//
							$('#'+screenId).show();
							$('#'+screenId).siblings().hide();
						}
					} else {
						$('#'+firstScreenId).show();
						selectedScreenId = firstScreenId;
						$('#'+selectedScreenId).siblings().hide();
					}
					//
					//
					if (screenId == 'rules-screen') {
						$('#unusedComponentsTable').hide();
						$('#ruleComponents').parent().show();
					} else {
						$('#unusedComponentsTable').show();
						$('#ruleComponents').parent().hide();
					}
					//
					console.log('>> Exiting select screen');
					// 
				}
				//
				function initialiseDragDrop() {
					var originOfMove;
					
					$("div.draggableCell")
				
					.drag("start", function (ev, dd) {
						$(this).addClass('dragging');
						originOfMove = $(this).parent();
					})
						.drag(function (ev, dd) {
							var drop = dd.drop[0],
								method = $.data(
									drop || {}, "drop+reorder");
							if (drop && (drop != dd.current || method != dd.method)) {
								$(this)[method](
									drop);
								dd.current = drop;
								dd.method = method;
								dd.update();
							}
						})
						.drag("end", function (ev, dd) {
							$(this).removeClass('dragging');
							//
							// Check if this field should be allowed in this position
							var attType = $(this).attr('attType');
							var attMax = $(this).attr('attMax');
							var attMultiSelect = $(this).attr('attMultiSelect');
							if (!($(this).parent().parent().attr('Id').match('related-lists')) && ((attType == 'Related Product' && ((attMax > 1) || attMax == '' || attMax == 'undefined')) || (attType == 'Lookup' && attMultiSelect == 'true'))) {
								growlNow('This attribute will be added to the "Related Lists" section as it is a related list');
								relatedLists = $('#usedComponentsTablesX-related-lists-'+$(this).parent().parent().parent().attr('Id'));
								$(this).detach().appendTo(relatedLists);
								$(this).removeClass('singleCellSize').addClass('doubleCellSize');
							} else if (($(this).parent().parent().attr('Id').match('related-lists')) && (!(attType == 'Related Product' && ((attMax > 1) || attMax == '' || attMax == 'undefined')) && !(attType == 'Lookup' && attMultiSelect == 'true'))) {
								growlNow('This attribute will be returned to its original container as it should not be added to the related lists section');
								$(this).detach().appendTo(originOfMove);
							} else if ($(this).parent().parent().attr('Id').match('related-lists')) {
								$(this).removeClass('singleCellSize').addClass('doubleCellSize');
								$(this).find('.toggle-image').attr('src','{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'contract-column-12.png')}');
							}
							//
							if ($(this).parent().parent().parent().parent().attr('id') == 'screens') {
								$(this).find('.toggle-image').show();
								if (!$(this).hasClass('singleCellSizeSpacer')) {
									$(this).find('.delete-image').attr('src',
										'{!URLFOR($Resource.ProductDefinitionBuilderIcons, "remove-attribute-12.png")}'
									);
									$(this).find('.delete-image').attr('title', 'Remove attribute');
									$(this).find('.delete-image').attr('onClick',
										"removeAttributeFromScreen($(this).parent().attr('id'),'single delete');"
									);
									$(this).find('.delete-image').addClass('remove-image');
									$(this).find('.delete-image').removeClass('delete-image');
								}
							} else {
								$(this).find('.toggle-image').hide();
								$(this).find('.remove-image').attr('src',
									'{!URLFOR($Resource.ProductDefinitionBuilderIcons, "delete-12.png")}'
								);
								$(this).find('.remove-image').attr('title', 'Delete attribute');
								$(this).find('.remove-image').attr('onClick',
									"deleteAttribute($(this).parent().attr('id'));");
								$(this).find('.remove-image').addClass('delete-image');
								$(this).find('.remove-image').removeClass('remove-image');
							}
						})
						.drop("init", function (ev, dd) {
							return !(this == dd.drag);
						})
						.drop("end", function (ev, dd) {
							//console.log($(this).attr('id'));
						});
					//
					$.drop({
						tolerance: function (event, proxy, target) {
							var test = event.pageY > (target.top + target.height / 2);
							$.data(target.elem, "drop+reorder", test ? "insertAfter" :
								"insertBefore");
							return this.contains(
								target, [
									event.pageX, event.pageY
								]);
						}
					});
					//
					$('.outer').unblock();
				}
				//
				function colSpanToggle(attImageId,force) {
					if ($(attImageId).parent().parent().parent().attr('Id').match('related-lists') && !force) {
						growlNow('Related lists will always span 2 columns');
					} else {
						if ($(attImageId).parent().hasClass('singleCellSize')) {
							$(attImageId).parent().removeClass('singleCellSize');
							$(attImageId).parent().addClass('doubleCellSize');
							$(attImageId).attr('src',
								'{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'contract-column-12.png')}');
						} else if ($(attImageId).parent().hasClass('doubleCellSize')) {
							$(attImageId).parent().removeClass('doubleCellSize');
							$(attImageId).parent().addClass('singleCellSize');
							$(attImageId).attr('src',
								'{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'expand-column-12.png')}');
						}
					}
				}
				//
				
				function escapeId(vfId) {
					var vfIdescaped = vfId.replace(/([ #;&,.%+*~\':"!^$[\]()=>|\/])/g,'\\\$1');
					return vfIdescaped;
				}
				//
				
				function getLayoutString() {
					// Loop through the layout and save it
					var layout = '';
					var layoutTmp = '';
					var screenId = '';
					var sectionId = '';
					var attributeId = '';
					var row = -1;
					var col = 0;
					$('#screens > div').each(function () {
						screenId = this.id;
						$('#' + this.id + ' > fieldset').each(function () {
							row++;
							sectionId = this.id;
							col = 0;
							$('#usedComponentsTablesX-' + sectionId + ' > div').each(
								function () {
									////console.log(this.id);
									if (this.id != '' && !this.id.match('spacer$')) {
										layoutTmp += this.id;
									} else {
										layoutTmp += 'blank';
									}
									//
									layoutTmp += ':' + row;
									if (col == 0) {
										layoutTmp += ':' + col;
										col++;
									} else if (col >= 1) {
										layoutTmp += ':' + col;
										col = 0;
										row++;
									}
									//
									attributeId = this.id;
									if (attributeId != '') {
										attributeId = escapeId(attributeId);
									}
									////console.log(attributeId);
									if ($('#' + attributeId).hasClass('singleCellSize')) {
										layoutTmp += ':' + 1;
									} else if ($('#' + attributeId).hasClass('doubleCellSize')) {
										layoutTmp += ':' + 2;
										col = 0;
										row++;
									} else {
										layoutTmp += ':na';
									}
									//
									if (sectionId.match('^general-info')) sectionId = 'GeneralInfo'; 
									if (sectionId.match('^related-lists')) sectionId = 'RelatedLists';  
									layoutTmp += ':' + screenId + ':' + sectionId + '-';
									//console.log(layoutTmp);
									layout += layoutTmp;
									layoutTmp = '';
								});
						});
					});
					//console.log(layout);
					return layout;
				}
				//
				function removeAttributeFromScreen(attributeId, source) {
					//console.log(attributeId + ' - Number of Children left: ' + $('#' +
					//	attributeId).parent().children('div').size());
					if (attributeId != '') {
						attributeId = escapeId(attributeId);
					}
					//
					// First check if this is the last child in the section, if so do not allow removal.
					if ($('#' + attributeId).parent().children('div').size() > 1 ||
						source == 'section delete' || source == 'screen delete') {
						if ($('#' + attributeId).hasClass('singleCellSize')) {
							$('#' + attributeId).detach().appendTo('#unusedComponentsTable');
						} else if ($('#' + attributeId).hasClass('doubleCellSize')) {
							$('#' + attributeId).addClass('singleCellSize').removeClass(
								'doubleCellSize');
							$('#' + attributeId).detach().appendTo('#unusedComponentsTable');
						} else if ($('#' + attributeId).hasClass('singleCellSizeSpacer')) {
							$('#' + attributeId).remove();
						}
						// Change images
						$('#' + attributeId).find('.toggle-image').hide();
						$('#' + attributeId).find('.remove-image').attr('src',
							'{!URLFOR($Resource.ProductDefinitionBuilderIcons, "delete-12.png")}'
						);
						$('#' + attributeId).find('.remove-image').attr('title',
							'Delete attribute');
						$('#' + attributeId).find('.remove-image').attr('onClick',
							"deleteAttribute($(this).parent().attr('id'));");
						$('#' + attributeId).find('.remove-image').addClass('delete-image');
						$('#' + attributeId).find('.remove-image').removeClass(
							'remove-image');
					} else {
						growlNow(
							'You should not remove the last element of a section unless you want to delete the whole section'
						);
					}
				}
				//
				function highlightNewRule(selectedRuleId) {
					selectedAttributeId = '';
					//console.log('**selectedRuleId: ' + selectedRuleId);
					// highlight the selected rule
					$('#rule-li-' + selectedRuleId).css('background', '#A4D48C');
					$('#rule-li-' + selectedRuleId).siblings().css('background', '#BCE');
				}
				//
				function deleteSection(sectionId) {
					var checkstr = confirm('Are you sure you want to delete section "' +
						$.trim($(sectionId).find('legend').text()) +
						'"?\n\nNote: Attributes contained within will not be deleted. they will be moved into the "Hidden components" container.'
					);
					if (checkstr == true) {
						var attributeId = '';
						$('#usedComponentsTablesX-' + $(sectionId).attr('id') + ' > div').each(
							function () {
								attributeId = this.id;
								////console.log(attributeId);
								removeAttributeFromScreen(attributeId, 'section delete')
							});
						$(sectionId).remove();
						// 
						console.log('section Id to Delete: '+$(sectionId).attr('id'));
						Visualforce.remoting.Manager.invokeAction(
							'{!$RemoteAction.ProductDesignerController.deleteSection}',
							$(sectionId).attr('id'), 
							handleDeleteSectionResponse,
							{escape: false}
						);
					} else {
						return false;
					}
				}
				//
				function handleDeleteSectionResponse(result, event) {
					if (event.type == 'exception') {
						growlNow(event.message);
					} else {
						section = result;
						growlNow('Section "'+section.Name+'" deleted successfully');
						//
						// Get Off Screen Attributes
						getOffScreenAttributes('{!cscfga__Product_Definition__c.Id}');
					}
				}
				//
				function deleteScreen(screenId) {
					var checkstr = confirm('Are you sure you want to delete screen "' +
						$('#Screen-Select').find('label.dd-selected-text').text() +
						'"?\n\nNote: Screen sections will also be deleted but attributes contained within will not be deleted. they will be moved into the "Hidden components" container.'
					);
					if (checkstr == true) {
						var sectionId = '';
						var attributeId = '';
						//
						//console.log('-----' + screenId);
						//
						$('#' + screenId + ' > fieldset').each(function () {
							sectionId = this.id;
							if (sectionId != '') {
								sectionId = escapeId(sectionId);
							}
							//console.log('#usedComponentsTablesX-' + sectionId + ' > div');
							$('#usedComponentsTablesX-' + sectionId + ' > div').each(function () {
								attributeId = this.id;
								////console.log(attributeId);
								removeAttributeFromScreen(attributeId, 'screen delete')
							});
							$('#' + sectionId).remove();
						});
						$('#screenId').remove();
						//
						//console.log('Screen Id to delete: ' + screenId);
						// 
						Visualforce.remoting.Manager.invokeAction(
							'{!$RemoteAction.ProductDesignerController.deleteScreen}',
							screenId, 
							handleDeleteScreenResponse,
							{escape: false}
						);
					} else {
						return false;
					}
				}
				//
				function handleDeleteScreenResponse(result, event) {
					if (event.type == 'exception') {
						growlNow(event.message);
					} else {
						screen = result;
						growlNow('Screen "'+screen.Name+'" deleted successfully');
						//
						// Get the list of screens
						loadScreenList('{!cscfga__Product_Definition__c.Id}');
						// Get Off Screen Attributes
						getOffScreenAttributes('{!cscfga__Product_Definition__c.Id}');
					}
				}
				//
				function deleteAttribute(attributeId) {
					var attributeName = $.trim($('#' + attributeId).text());
					var checkstr = confirm('Are you sure you want to delete attribute "' +
						attributeName +
						'"?\n\nNote: The page layout will also be saved at the same time.');
					if (checkstr == true) {
						blockScreenElement('#unusedComponentsTable');
						//console.log('Deleting attribute: "' + attributeName + '"');
						var layout = getLayoutString();
						//
						Visualforce.remoting.Manager.invokeAction(
							'{!$RemoteAction.ProductDesignerController.deleteAttribute}',
							attributeId, 
							handleDeleteAttributeResponse,
							{escape: false}
						);
					} else {
						//console.log('Cancelled deleting attribute: "' + attributeName + '"');
					}
				}
				//
				function handleDeleteAttributeResponse(result, event) {
					if (event.type == 'exception') {
						growlNow(event.message);
					} else {
						attribute = result;
						growlNow('Attribute "'+attribute.Name+'" deleted successfully');
						// Get Off Screen Attributes
						getOffScreenAttributes('{!cscfga__Product_Definition__c.Id}');
					}
				}
				//
				function deleteRule(ruleId, ruleName) {
					var checkstr = confirm('Are you sure you want to delete "' +
						ruleName + '"?\n\nNote: rule associations will also be deleted.');
					if (checkstr == true) {
						blockScreenElement('#centerColumn');
						//console.log('Deleting rule: "' + ruleName + '"');
						//
						Visualforce.remoting.Manager.invokeAction(
							'{!$RemoteAction.ProductDesignerController.deleteRule}',
							ruleId, 
							handleDeleteRuleResponse,
							{escape: false}
						);
					} else {
						//console.log('Cancelled deleting rule: "' + ruleName + '"');
					}
				}
				//
				function handleDeleteRuleResponse(result, event) {
					if (event.type == 'exception') {
						growlNow(event.message);
					} else {
						rule = result;
						growlNow('Rule "'+rule.Name+'" deleted successfully');
						createdRuleId = '';
						// Get On Screen Attributes
						loadRuleList('{!cscfga__Product_Definition__c.Id}');
						//
						$('.property-inspector').hide();
					}
				}
				//
				function deleteAction(actionId, actionName) {
					var checkstr = confirm('Are you sure you want to delete "' +
						actionName + '"?\n\nNote: rule associations will also be deleted.');
					if (checkstr == true) {
						blockScreenElement('#centerColumn');
						//console.log('Deleting rule: "' + ruleName + '"');
						//
						Visualforce.remoting.Manager.invokeAction(
							'{!$RemoteAction.ProductDesignerController.deleteAction}',
							actionId, 
							handleDeleteActionResponse,
							{escape: false}
						);
					} else {
						//console.log('Cancelled deleting action: "' + actionName + '"');
					}
				}
				//
				function handleDeleteActionResponse(result, event) {
					if (event.type == 'exception') {
						growlNow(event.message);
					} else {
						action = result;
						growlNow('Action "'+action.Name+'" deleted successfully');
						createdRuleId = '';
						// Get rule list
						loadRuleList('{!cscfga__Product_Definition__c.Id}');
						loadAttributeRuleComponentList('{!cscfga__Product_Definition__c.Id}');
						//
						$('.property-inspector').hide();
					}
				}
				//
				function deletePredicate(predicateId, predicateName) {
					var checkstr = confirm('Are you sure you want to delete "' +
						predicateName + '"?\n\nNote: rule associations will also be deleted.');
					if (checkstr == true) {
						blockScreenElement('#centerColumn');
						//console.log('Deleting predicate: "' + predicateName + '"');
						//
						Visualforce.remoting.Manager.invokeAction(
							'{!$RemoteAction.ProductDesignerController.deletePredicate}',
							predicateId, 
							handleDeletePredicateResponse,
							{escape: false}
						);
					} else {
						//console.log('Cancelled deleting predicate: "' + predicateName + '"');
					}
				}
				//
				function handleDeletePredicateResponse(result, event) {
					if (event.type == 'exception') {
						growlNow(event.message);
					} else {
						predicate = result;
						growlNow('Predicate "'+predicate.Name+'" deleted successfully');
						createdRuleId = '';
						// Get rule list
						loadRuleList('{!cscfga__Product_Definition__c.Id}');
						loadAttributeRuleComponentList('{!cscfga__Product_Definition__c.Id}');
						//
						$('.property-inspector').hide();
					}
				}
				//
				function uploadDefinitionLayer() {
					var iFrame =
						'<iframe id="overlayIframe" src="/apex/UploadProductDefinition?id={!cscfga__Product_Definition__c.Id}&currentStep=0"></iframe>';
					showProgress(iFrame, '');
					$("#processing_overlay").click(function () {
						hideProgress();
					});
				}
				//
				function exportOrCloneLayer() {
					var iFrame =
						'<iframe id="overlayIframe" src="/apex/ExportOrCloneAttribute?id={!cscfga__Product_Definition__c.Id}"></iframe>';
					showProgress(iFrame, '');
					$("#processing_overlay").click(function () {
						hideProgress();
					});
				}
				//
				function addSpacer() {
					$('#unusedComponentsTable').append(
						'<div class="draggableCell singleCellSizeSpacer spacerDiv" id="1-spacer" value="Spacer"><img class="label-image" src="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'spacer-20.png ')}" title="Spacer" style="width: 12px; height:12px;"/><img class="delete-image" title="Delete spacer" src="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'delete-12.png ')}"  onClick="removeAttributeFromScreen($(this).parent().attr(\'id\'),\'single delete\');"/></div>'
					);
					jQuery(function ($) {
				
						$("div.draggableCell")
				
						.drag("start", function (ev, dd) {
							$(this).addClass('dragging');
						})
				
						.drag(function (ev, dd) {
							var drop = dd.drop[0],
								method = $.data(
									drop || {}, "drop+reorder");
							if (drop && (drop != dd.current || method != dd.method)) {
								$(this)[method](
									drop);
								dd.current = drop;
								dd.method = method;
								dd.update();
							}
						})
				
				
						.drag("end", function (ev, dd) {
							$(this).removeClass('dragging');
						})
				
						.drop("init", function (ev, dd) {
							return !(this == dd.drag);
						});
				
				
						$.drop({
							tolerance: function (event, proxy, target) {
								var test = event.pageY > (target.top + target.height / 2);
								$.data(target.elem, "drop+reorder", test ? "insertAfter" :
									"insertBefore");
								return this.contains(
									target, [
										event.pageX, event.pageY
									]);
							}
						});
					});
				}
				
				function makeRulesSortable() {
					$('#rule-div').sortable({
						placeholder: 'placeholder',
						cursor: 'move', handle: ".handle", cursorAt: { left: 400, top: 100 }
					});
					$('#rule-div').disableSelection();
					//
					$('#predicate-div').sortable({
						placeholder: 'placeholder',
						cursor: 'move', handle: ".handle", cursorAt: { left: 400, top: 100 }
					});
					$('#predicate-div').disableSelection();
					//
					$('#action-normal-div').sortable({
						connectWith: '#action-else-div',
						placeholder: 'placeholder',
						cursor: 'move', handle: ".handle", cursorAt: { left: 400, top: 100 }
					});
					$('#action-normal-div').disableSelection();
					//
					$('#action-else-div').sortable({
						connectWith: '#action-normal-div',
						placeholder: 'placeholder',
						cursor: 'move', handle: ".handle", cursorAt: { left: 400, top: 100 }
					});
					$('#action-else-div').disableSelection();
					//
		    		var oldList, newList, item;
					$('.single-col-rule-div').sortable({
						connectWith: '#action-normal-div,#action-else-div,#predicate-div',
						placeholder: 'placeholder-rules-component',
						cursor: 'move',
						start: function(event, ui) {
				            item = ui.item;
				            newList = oldList = ui.item.parent();
				        },
				        stop: function(event, ui) {          
				            console.log("Moved " + item.attr('type')+':'+item.attr('Id') + " from " + oldList.attr('id') + " to " + newList.attr('id'));
				            //
				            $(this).sortable('cancel');
				            //
				            console.log(item.attr('type'));
				            if (item.attr('type') == 'action' && newList.attr('id') == 'predicate-div') {
				            	if (!$('#action-normal-div').find('#'+item.attr('Id')).doesExist()) {
				            		growlNow('The action will be moved to the "Rule actions - Normal" section');
				            		var clonedActionItem = item.clone().attr('type',item.attr('Id')).appendTo('#action-normal-div');
				            		//
				            		$(clonedActionItem).find('.setup-image').remove();
				            		$(clonedActionItem).find('.delete-image').attr('onClick','$(this).parent().remove();');
				            	} else {
				            		growlNow('This '+item.attr('type')+' is already associated with this rule');
				            	}
				            } else if (item.attr('type') == 'predicate' && (newList.attr('id') == 'action-normal-div' || newList.attr('id') == 'action-else-div')) {
				            	// Check if this prdicate is already associated with this rule
				            	if (!$('#predicate-div').find('#'+item.attr('Id')).doesExist()) {
				            		growlNow('The predicate will be moved to the "Rule predicate" section');
				            		var clonedPredicateItem = item.clone().appendTo('#predicate-div');
				            		//
				            		$(clonedPredicateItem).find('.setup-image').remove();
				            		$(clonedPredicateItem).find('.delete-image').attr('onClick','$(this).parent().remove();');
				            	} else {
				            		growlNow('This '+item.attr('type')+' is already associated with this rule');
				            	}
				            } else {
				            	if (!$('#'+newList.attr('id')).find('#'+item.attr('Id')).doesExist()) {
				            		var clonedItem = item.clone().appendTo('#'+newList.attr('id'));
				            		//
				            		$(clonedItem).find('.setup-image').remove();
				            		$(clonedItem).find('.delete-image').attr('onClick','$(this).parent().remove();');
				            	} else {
				            		growlNow('This '+item.attr('type')+' is already associated with this rule '+newList.attr('id'));
				            	}
				            }
				        },
				        change: function(event, ui) {  
				            newList = ui.placeholder.parent();
				        }
					});
					$('.single-col-rule-div').disableSelection();
					
				}
				//
				$.fn.doesExist = function(){
					return jQuery(this).length > 0;
				}
				//
				function toggleRuleComponentsDetails(image, attId) {
					var imageId = $(image).attr('Id');
					var imageSrc = $(image).attr('src');
					//console.log('Hierarchy imageId:' + imageId);
					//console.log('Hierarchy div attId:' + attId);
					if (imageSrc.match('expand.png$')) {
						$(image).attr('src',
							"{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'collapse.png')}"
						);
						//$('#predicate-action-div-' + attId).show();
						//$('#predicate-action-div-' + attId).children().show();
						//$('#predicate-action-div-' + attId).children().children().show();
						//
						$('#predicate-action-div-' + attId).parent().children(
							'.single-col-rule-div').children('.rule-li').show();
						$('#predicate-action-div-' + attId).parent().children(
							'.single-col-rule-div').children('.rule-li').children().show();
					} else {
						$(image).attr('src',
							"{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'expand.png')}"
						);
						//$('#predicate-action-div-' + attId).hide();
						//$('#predicate-action-div-' + attId).children().hide();
						//$('#predicate-action-div-' + attId).children().children().hide();
						//
						$('#predicate-action-div-' + attId).parent().children(
							'.single-col-rule-div').children('.rule-li').hide();
						$('#predicate-action-div-' + attId).parent().children(
							'.single-col-rule-div').children('.rule-li').children().hide();
					}
				}
				//
				function openRuleComponentsDetails(image, attId) {
					var imageId = $(image).attr('Id');
					var imageSrc = $(image).attr('src');
					console.log('Hierarchy imageId:' + imageId);
					console.log('Hierarchy div attId:' + attId);
					//
					$('.hierarchy-image').attr('src',
						"{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'expand.png')}"
					);
					$('#ruleComponents').children('fieldset').children('ul').children('li').children(
						'.single-col-rule-div').children('.rule-li').hide();
					$('#ruleComponents').children('fieldset').children('ul').children('li').children(
						'.single-col-rule-div').children('.rule-li').children().hide();
					//
					$(image).attr('src',
						"{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'collapse.png')}"
					);
					//$('#predicate-action-div-' + attId).show();
					//$('#predicate-action-div-' + attId).children().show();
					//$('#predicate-action-div-' + attId).children().children().show();
					//
					$('#predicate-action-div-' + attId).parent().children(
						'.single-col-rule-div').children('.rule-li').show();
					$('#predicate-action-div-' + attId).parent().children(
						'.single-col-rule-div').children('.rule-li').children().show();
				}
				//
				function toggleAllRuleComponentsDetails(image, divId) {
					var imageId = $(image).attr('Id');
					var imageSrc = $(image).attr('src');
					//console.log('Hierarchy imageId:' + imageId);
					//console.log('Hierarchy div Id:' + divId);
					if (imageSrc.match('expand.png$')) {
						$(image).attr('src',
							"{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'collapse.png')}"
						);
						$('.hierarchy-image').attr('src',
							"{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'collapse.png')}"
						);
						$('#' + divId).children('fieldset').children('ul').children('li').children(
							'.single-col-rule-div').children('.rule-li').show();
						$('#' + divId).children('fieldset').children('ul').children('li').children(
							'.single-col-rule-div').children('.rule-li').children().show();
					} else {
						$(image).attr('src',
							"{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'expand.png')}"
						);
						$('.hierarchy-image').attr('src',
							"{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'expand.png')}"
						);
						$('#' + divId).children('fieldset').children('ul').children('li').children(
							'.single-col-rule-div').children('.rule-li').hide();
						$('#' + divId).children('fieldset').children('ul').children('li').children(
							'.single-col-rule-div').children('.rule-li').children().hide();
					}
				}
				//
				function toggleSectionDisplay(image) {
					$(image).parent().parent().children('div').slideToggle();
					var imageSrc = $(image).attr('src');
					if (imageSrc.match('expand-12.png$')) {
						$(image).attr('src',
								"{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'collapse-12.png')}"
							);
					} else {
						$(image).attr('src',
								"{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'expand-12.png')}"
							);
					}
				}
				//
				function toggleSectionHeight(image) {
					var imageSrc = $(image).attr('src');
					if (imageSrc.match('collapse-12.png$')) {
						$(image).attr('src',
								"{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'expand-12.png')}"
							);
						//
						$(image).parent().parent().find('div').css('min-height','100px');
					} else {
						$(image).attr('src',
								"{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'collapse-12.png')}"
							);
						//
						$(image).parent().parent().find('div').css('min-height','600px');
					}
				}
				//
				var screenOptions;
				var parentScreenOptionsUl;
				function switchContext(image,selectedScreen, goToScreens) {
					//
					//console.log('>> Entering Switching context:'+$(image).attr('src'));
					$('.property-inspector').hide();
					//
					if (goToScreens == null) goToScreens = false;
					if (!goToScreens && $(image).attr('src').match('rule-20.png')) {
						//
						blockScreenElement('.outer');
						console.log('>>>> Switching to Rule management');
						// reset the selected rule id:
						$('#rulePropertyInspectorId > table').find('#rule-id').val('') ;
						//
						selectedMasterRelationshipId = '';
						//
						$(image).attr('src','{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'screen-24.png')}');
						$(image).attr('title','Switch to screen management');
						//
						loadRuleList('{!cscfga__Product_Definition__c.Id}');
						//
						loadAttributeRuleComponentList('{!cscfga__Product_Definition__c.Id}');
						//
						growlNow('Switched context to "Rules" management');
					} else {
						//
						blockScreenElement('.outer');
						console.log('>>>> Switching to Screen management');
						// reset the selected rule id:
						$('#rulePropertyInspectorId > table').find('#rule-id').val('');
						//
						$(image).attr('src','{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'rule-20.png')}');
						$(image).attr('title','Switch to rules management');
						$('#rules-screen').siblings().show();
						$('#rules-screen').remove();
						$('.all-contexts').show();
						$('.rule-contexts').hide();
						$('.screen-contexts').show();
						//
						//console.log('>>>>>>>selectedScreen: '+selectedScreen);
						//
						if (selectedScreen != '' && selectedScreen != undefined) {
							selectedScreenId = selectedScreen;
						} else {
							selectedScreenId = $('#screens').children().first().attr('Id');
						}
						if (selectedScreenId == 'rules-screen') {
							selectScreen('');
							$('#rules-screen').find('fieldset').hide();
						} else {
							selectScreen(selectedScreenId);
						}
						$('#'+selectedScreenId).siblings().hide();
						$('input[value*="rules-screen"]').parent().parent().hide();
						$('input[value*="rules-screen"]').parent().parent().siblings().show();
						$('#save-image').attr('onClick','var layout = getLayoutString(); saveLayout(\'{!cscfga__Product_Definition__c.Id}\',layout);');
						//
						$('.outer').unblock();
						//
						growlNow('Switched context to "Screen" management');
					}
					//
					//console.log('>> Exiting Switching context');
					//
				}
				
				function switchPin(image, side) {
					if ($(image).attr('src').match('black_push_pin.png')) {
						//
				        $(image).attr('src','{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'green_push_pin.png')}');
						$(image).attr('title','Switch to float');
						//
				        $('#propertyInspector').removeClass('div-block').addClass('div-table');
				        //
		    			$(document).scroll(function() {
					        $('#top-left-column').css('position','relative');
					        $('#top-right-column').css('position','relative');
					        $('#top-centre-column').css('padding-left','0px');
					        $('#header-top-centre-column').css('padding-left','0px');
					        //
						});
					} else if ($(image).attr('src').match('green_push_pin.png')) {
						//
				        $(image).attr('src','{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'black_push_pin.png')}');
						$(image).attr('title','Switch to fixed');
						//
		    			$(document).scroll(function() {
							if ($(this).scrollTop() > 0) {
						        //console.log($(this).scrollTop());
						        $('#top-left-column').css('position','fixed');
						        $('#top-left-column').css('z-index','100');
						        $('#top-right-column').css('position','fixed');
						        $('#top-right-column').css('z-index','100');
						        $('#top-centre-column').css('padding-left','240px');
						        $('#header-top-centre-column').css('padding-left','240px');
						    } else {
						        $('#top-left-column').css('position','relative');
						        $('#top-right-column').css('position','relative');
						        $('#top-centre-column').css('padding-left','0px');
						        $('#header-top-centre-column').css('padding-left','0px');
						    }
						});
				        //
				        $('#propertyInspector').removeClass('div-table').addClass('div-block');
					}
				}
		    </script>
		    <!--  -->
		    
            <table cellspacing="8" border="0" id="containerTable">
                <tr>
                    <th colspan="3">
                        <apex:outputText value="{!cscfga__Product_Definition__c.Name}"/>
                        (<a href="/{!cscfga__Product_Definition__c.Id}" target="_blank">Go to standard interface</a>)
                    </th>
                </tr>
                <tr>
                    <th>
                        Components
                    </th>
                    <th id="header-top-centre-column">
                        Workbench
                    </th>
                    <th>
                        Property inspector
                    </th>
                </tr>
                <tr>
                    <td height="400px" id="top-left-column" style="vertical-align: top; min-width: 310px;">
                    	<div style="min-width:302px; background-color: #fff; height: 36px;">
	                    	<select id="Add-Attribute-Select">
		                    	<option value="-1" data-description="" data-imagesrc="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'add-attribute-24.png')}">Create a new attribute</option>
		                    	<option value="Calculation" data-description="" data-imagesrc="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'calculation-20.png')}">Calculation</option>
		                    	<option value="Checkbox" data-description="" data-imagesrc="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'checkbox-20.png')}">Checkbox</option>
		                    	<option value="Date" data-description="" data-imagesrc="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'date-20.png')}">Date</option>
		                    	<option value="Lookup" data-description="" data-imagesrc="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'lookup-20.png')}">Lookup</option>
		                    	<option value="Radio Button" data-description="" data-imagesrc="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'radio-20.png')}">Radio Button</option>
		                    	<option value="Related Product" data-description="" data-imagesrc="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'related-product-20.png')}">Related Product</option>
		                    	<option value="Select List" data-description="" data-imagesrc="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'select-list-20.png')}">Select List</option>
		                    	<option value="Text Display" data-description="" data-imagesrc="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'text-display-20.png')}">Text Display</option>
		                    	<option value="User Input" data-description="" data-imagesrc="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'user-input-20.png')}">User Input</option>
		                    	<option value="Spacer" data-description="" data-imagesrc="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'spacer-20.png')}">Spacer</option>
	                    	</select>
	                    	 <img id="left-panel-pin-switcher" title="Switch to fixed" onClick="switchPin(this);" src="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'black_push_pin.png')}" style="margin-top:7px; width:16px; height:16px;"/>
                    	</div>
    					<div id="leftColumn">
    						<!-- This is the Off Screen attributes Div -->
	                        <div class="div-block singleColumnTableSize" id="unusedComponentsTable" style="min-height: 464px">
	                            
	                        </div>
	                        <div id="leftColumnRulesComponents">
		                        <div class="div-block singleColumnTableSize" id="ruleComponents" style="min-height: 464px">
		                        	<fieldset id="rule-components-fieldset" style="margin-top:5px;margin-bottom:5px;">
			                        	<legend>
			                        		Predicates &amp; Actions
			                        		<img title="Expand All" src="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'expand.png')}" id="expand-all" onClick="toggleAllRuleComponentsDetails(this,'ruleComponents')"/>
			                        	</legend>
		                           	</fieldset>
		                        </div>
	                        </div>
	                	</div>
                    </td>
                    <td  id="top-centre-column" style="min-width: 610px;">
                    	<div id="fullCenterColumn">
	                    	<div style="min-width: 610px;background-color: #fff; height: 36px;">
	                    		<ul style="display:inline;">
		                    		<li style="cursor:pointer; display:inline-block; float:left; list-style:none; margin-left: 0px;">
	   									<img id="workbench-switcher" title="Switch to screen management" onClick="switchContext(this);" src="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'screen-24.png')}" style="margin-top:7px; width:20px; height:20px;"/>
	   								</li>
	   								<li style="cursor:pointer; display:inline-block; float:left; list-style:none; margin-left: 5px;">
				                    	<select id="Screen-Select">
					                        
				                    	</select>
			                    	</li>
		                    		<li class="all-contexts"    style="cursor:pointer; display:inline-block; float:right; list-style:none;"><img title="Save" id="save-image" onClick="var layout = getLayoutString(); saveLayout('{!cscfga__Product_Definition__c.Id}',layout);" src="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'save-20.png')}" style="margin-top:7px; width:20px; height:20px;"/></li>
		                    		<li class="screen-contexts" style="cursor:pointer; display:inline-block; float:right; list-style:none;"><img title="Upload/Update product definition" onClick="uploadDefinitionLayer();" src="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'upload-to-database-20.png')}" style="margin-top:7px; width:20px; height:20px;"/></li>
		                    		<li class="screen-contexts" style="cursor:pointer; display:inline-block; float:right; list-style:none;"><img title="Export/Clone attribute definition" onClick="exportOrCloneLayer();" src="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'copy-20.png')}" style="margin-top:7px; width:20px; height:20px;"/></li>
		                    		<li class="screen-contexts" style="cursor:pointer; display:inline-block; float:right; list-style:none;"><img title="Sort screens" onClick="displaySortScreen('Screens','{!cscfga__Product_Definition__c.Id}');" src="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'sort-20.png')}" style="margin-top:7px; width:20px; height:20px;"/></li>
		                    		<li class="screen-contexts" style="cursor:pointer; display:inline-block; float:right; list-style:none;"><img title="Add screen" onClick="addScreenLayer();" src="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'add-screen-24.png')}" style="margin-top:7px; width:20px; height:20px;"/></li>
		                    		<li class="screen-contexts" style="cursor:pointer; display:inline-block; float:right; list-style:none;"><img title="Add section to current screen" onClick="addSectionLayer();" src="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'add-section-24.png')}" style="margin-top:7px; width:20px; height:20px;"/></li>
		                    		<li class="rule-contexts"   style="cursor:pointer; display:inline-block; float:right; list-style:none;"><img title="Add rule to this product" onClick="addRule('{!cscfga__Product_Definition__c.Id}');" src="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'add-rule-20.png')}" style="margin-top:7px; width:20px; height:20px;"/></li>
		                    		<li class="screen-contexts" style="cursor:pointer; display:inline-block; float:right; list-style:none;"><img title="Delete screen" onClick="deleteScreen(selectedScreenId);" src="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'delete-24.png')}" style="margin-top:7px; width:20px; height:20px;"/></li>
		                    		<li class="screen-contexts" style="cursor:pointer; display:inline-block; float:right; list-style:none;"><img title="Screen properties" onClick="getScreenDetails(selectedScreenId);" src="{!URLFOR($Resource.ProductDefinitionBuilderIcons, 'edit-settings-24.png')}" style="margin-top:7px; width:20px; height:20px;"/></li>
		                    	</ul>
	                    	</div>
	                    	
	    					<div id="centerColumn">
		                        <div id="screens" style="display:inline; margin-left:0px; min-width: 550px; min-height: 500px;">
		                            
		                    	</div>
		                	</div>
		                </div>
                    </td>
                    
                    <td id="top-right-column" style="vertical-align: top; min-width: 310px;">
                        <div class="div-block singleColumnTableSize propertyInspector" id="propertyInspector">
                           	<fieldset class="property-inspector attribute-properties" id='attributePropertyInspector-Calculation'>
                           		<legend>Attribute Details</legend>
                                <table>
                                    <tr>
                                        <td colspan="2" align="center">
                                            <input type="button" value="Update Attribute" onClick="saveAttribute($(this),$(this).parent().find('#attribute-id').val());"/>
                                            <input type="hidden" class="attribute-id" id="attribute-id" value="" />
                                        </td>
                                    </tr>
                                    <apex:repeat value="{! $ObjectType.cscfga__Attribute_Definition__c.FieldSets['CalculationProperties']}" var="att">
                                        <tr>
                                            <td align="left" class="field-label">
                                                <apex:outputText value="{!att.label}" />
                                                <input type="hidden" name="attribute-id" id="attribute-id" value="" />
                                            </td>
                                            <td align="left">
                                            	<apex:outputPanel layout="none" rendered="{!IF(att.label == 'Default Value',true,false)}">
                                                	<apex:inputField value="{!selectedAttribute[att.fieldPath]}" styleClass="accept-expression" id="default-value" required="{!OR(att.required, att.dbrequired)}"/>
                                                </apex:outputPanel>
                                            	<apex:outputPanel layout="none" rendered="{!IF(att.Label == 'Line Item Description',true,false)}">
                                                	<apex:inputField value="{!selectedAttribute[att.fieldPath]}" styleClass="accept-expression" id="line-item-description" required="{!OR(att.required, att.dbrequired)}"/>
                                                </apex:outputPanel>
                                            	<apex:outputPanel layout="none" rendered="{!IF(att.label != 'Default Value' && att.Label != 'Line Item Description',true,false)}">
                                                	<apex:inputField value="{!selectedAttribute[att.fieldPath]}" required="{!OR(att.required, att.dbrequired)}"/>
                                                </apex:outputPanel>
                                            </td>
                                        </tr>
                                    </apex:repeat>
                                    <tr>
                                        <td colspan="2" align="center">
                                            <input type="button" value="Update Attribute" onClick="saveAttribute($(this),$(this).parent().find('#attribute-id-bottom').val());"/>
                                            <input type="hidden" class="attribute-id" id="attribute-id-bottom" value="" />
                                        </td>
                                    </tr>
                                </table>
							</fieldset>
							<fieldset class="property-inspector attribute-properties" id='attributePropertyInspector-Checkbox'>
                           		<legend>Attribute Details</legend>
                                <table>
                                    <tr>
                                        <td colspan="2" align="center">
                                            <input type="button" value="Update Attribute" onClick="saveAttribute($(this),$(this).parent().find('#attribute-id').val());"/>
                                            <input type="hidden" class="attribute-id" id="attribute-id" value="" />
                                        </td>
                                    </tr>
                                    <apex:repeat value="{! $ObjectType.cscfga__Attribute_Definition__c.FieldSets['CheckboxProperties']}" var="att">
                                        <tr>
                                            <td align="left" class="field-label">
                                                <apex:outputText value="{!att.label}" />
                                            </td>
                                            <td align="left">
                                            	<apex:outputPanel layout="none" rendered="{!IF(att.label == 'Default Value',true,false)}">
                                                	<apex:inputField value="{!selectedAttribute[att.fieldPath]}" styleClass="accept-expression" id="default-value" required="{!OR(att.required, att.dbrequired)}"/>
                                                </apex:outputPanel>
                                            	<apex:outputPanel layout="none" rendered="{!IF(att.Label == 'Line Item Description',true,false)}">
                                                	<apex:inputField value="{!selectedAttribute[att.fieldPath]}" styleClass="accept-expression" id="line-item-description" required="{!OR(att.required, att.dbrequired)}"/>
                                                </apex:outputPanel>
                                            	<apex:outputPanel layout="none" rendered="{!IF(att.label != 'Default Value' && att.Label != 'Line Item Description',true,false)}">
                                                	<apex:inputField value="{!selectedAttribute[att.fieldPath]}" required="{!OR(att.required, att.dbrequired)}"/>
                                                </apex:outputPanel>
                                            </td>
                                        </tr>
                                    </apex:repeat>
                                    <tr>
                                        <td colspan="2" align="center">
                                            <input type="button" value="Update Attribute" onClick="saveAttribute($(this),$(this).parent().find('#attribute-id-bottom').val());"/>
                                            <input type="hidden" class="attribute-id" id="attribute-id" value="" />
                                        </td>
                                    </tr>
                                </table>
							</fieldset>
							<fieldset class="property-inspector attribute-properties" id='attributePropertyInspector-Date'>
                           		<legend>Attribute Details</legend>
                                <table>
                                    <tr>
                                        <td colspan="2" align="center">
                                            <input type="button" value="Update Attribute" onClick="saveAttribute($(this),$(this).parent().find('#attribute-id').val());"/>
                                            <input type="hidden" class="attribute-id" id="attribute-id" value="" />
                                        </td>
                                    </tr>
                                    <apex:repeat value="{! $ObjectType.cscfga__Attribute_Definition__c.FieldSets['DateProperties']}" var="att">
                                        <tr>
                                            <td align="left" class="field-label">
                                                <apex:outputText value="{!att.label}" />
                                            </td>
                                            <td align="left">
                                            	<apex:outputPanel layout="none" rendered="{!IF(att.label == 'Default Value',true,false)}">
                                                	<apex:inputField value="{!selectedAttribute[att.fieldPath]}" styleClass="accept-expression" id="default-value" required="{!OR(att.required, att.dbrequired)}"/>
                                                </apex:outputPanel>
                                            	<apex:outputPanel layout="none" rendered="{!IF(att.Label == 'Line Item Description',true,false)}">
                                                	<apex:inputField value="{!selectedAttribute[att.fieldPath]}" styleClass="accept-expression" id="line-item-description" required="{!OR(att.required, att.dbrequired)}"/>
                                                </apex:outputPanel>
                                            	<apex:outputPanel layout="none" rendered="{!IF(att.label != 'Default Value' && att.Label != 'Line Item Description',true,false)}">
                                                	<apex:inputField value="{!selectedAttribute[att.fieldPath]}" required="{!OR(att.required, att.dbrequired)}"/>
                                                </apex:outputPanel>
                                            </td>
                                        </tr>
                                    </apex:repeat>
                                    <tr>
                                        <td colspan="2" align="center">
                                            <input type="button" value="Update Attribute" onClick="saveAttribute($(this),$(this).parent().find('#attribute-id-bottom').val());"/>
                                            <input type="hidden" class="attribute-id" id="attribute-id-bottom" value="" />
                                        </td>
                                    </tr>
                                </table>
							</fieldset>
							<fieldset class="property-inspector attribute-properties" id='attributePropertyInspector-Lookup'>
                           		<legend>Attribute Details</legend>
                                <table>
                                    <tr>
                                        <td colspan="2" align="center">
                                            <input type="button" value="Update Attribute" onClick="saveAttribute($(this),$(this).parent().find('#attribute-id').val());"/>
                                            <input type="hidden" class="attribute-id" id="attribute-id" value="" />
                                        </td>
                                    </tr>
                                    <apex:repeat value="{! $ObjectType.cscfga__Attribute_Definition__c.FieldSets['LookupProperties']}" var="att">
                                        <tr>
                                            <td align="left" class="field-label">
                                                <apex:outputText value="{!att.label}" />
                                            </td>
                                            <td align="left">
                                            	<apex:outputPanel layout="none" rendered="{!IF(att.label == 'Default Value',true,false)}">
                                                	<apex:inputField value="{!selectedAttribute[att.fieldPath]}" styleClass="accept-expression" id="default-value" required="{!OR(att.required, att.dbrequired)}"/>
                                                </apex:outputPanel>
                                            	<apex:outputPanel layout="none" rendered="{!IF(att.Label == 'Line Item Description',true,false)}">
                                                	<apex:inputField value="{!selectedAttribute[att.fieldPath]}" styleClass="accept-expression" id="line-item-description" required="{!OR(att.required, att.dbrequired)}"/>
                                                </apex:outputPanel>
                                            	<apex:outputPanel layout="none" rendered="{!IF(att.label != 'Default Value' && att.Label != 'Line Item Description',true,false)}">
                                                	<apex:inputField value="{!selectedAttribute[att.fieldPath]}" required="{!OR(att.required, att.dbrequired)}"/>
                                                </apex:outputPanel>
                                            </td>
                                        </tr>
                                    </apex:repeat>
                                    <tr>
                                        <td colspan="2" align="center">
                                            <input type="button" value="Update Attribute" onClick="saveAttribute($(this),$(this).parent().find('#attribute-id-bottom').val());"/>
                                            <input type="hidden" class="attribute-id" id="attribute-id-bottom" value="" />
                                        </td>
                                    </tr>
                                </table>
							</fieldset>
							<fieldset class="property-inspector attribute-properties" id='attributePropertyInspector-RadioButton'>
                           		<legend>Attribute Details</legend>
                                <table>
                                    <tr>
                                        <td colspan="2" align="center">
                                            <input type="button" value="Update Attribute" onClick="saveAttribute($(this),$(this).parent().find('#attribute-id').val());"/>
                                            <input type="hidden" class="attribute-id" id="attribute-id" value="" />
                                        </td>
                                    </tr>
                                    <apex:repeat value="{! $ObjectType.cscfga__Attribute_Definition__c.FieldSets['RadioButton']}" var="att">
                                        <tr>
                                            <td align="left" class="field-label">
                                                <apex:outputText value="{!att.label}" />
                                            </td>
                                            <td align="left">
                                            	<apex:outputPanel layout="none" rendered="{!IF(att.label == 'Default Value',true,false)}">
                                                	<apex:inputField value="{!selectedAttribute[att.fieldPath]}" styleClass="accept-expression" id="default-value" required="{!OR(att.required, att.dbrequired)}"/>
                                                </apex:outputPanel>
                                            	<apex:outputPanel layout="none" rendered="{!IF(att.Label == 'Line Item Description',true,false)}">
                                                	<apex:inputField value="{!selectedAttribute[att.fieldPath]}" styleClass="accept-expression" id="line-item-description" required="{!OR(att.required, att.dbrequired)}"/>
                                                </apex:outputPanel>
                                            	<apex:outputPanel layout="none" rendered="{!IF(att.label != 'Default Value' && att.Label != 'Line Item Description',true,false)}">
                                                	<apex:inputField value="{!selectedAttribute[att.fieldPath]}" required="{!OR(att.required, att.dbrequired)}"/>
                                                </apex:outputPanel>
                                            </td>
                                        </tr>
                                    </apex:repeat>
                                    <tr>
                                    	<td colspan="2" align="center">
                                    		<div id="RadioButton-selectOptionsDiv">
                                    		</div>
                                    	</td>
                                    </tr>
                                    <tr>
                                        <td colspan="2" align="center">
                                            <input type="button" value="Update Attribute" onClick="saveAttribute($(this),$(this).parent().find('#attribute-id-bottom').val());"/>
                                            <input type="hidden" class="attribute-id" id="attribute-id-bottom" value="" />
                                        </td>
                                    </tr>
                                </table>
							</fieldset>
							<fieldset class="property-inspector attribute-properties" id='attributePropertyInspector-RelatedProduct'>
                           		<legend>Attribute Details</legend>
                                <table>
                                    <tr>
                                        <td colspan="2" align="center">
                                            <input type="button" value="Update Attribute" onClick="saveAttribute($(this),$(this).parent().find('#attribute-id').val());"/>
                                            <input type="hidden" class="attribute-id" id="attribute-id" value="" />
                                        </td>
                                    </tr>
                                    <apex:repeat value="{! $ObjectType.cscfga__Attribute_Definition__c.FieldSets['RelatedProduct']}" var="att">
                                        <tr>
                                            <td align="left" class="field-label">
                                                <apex:outputText value="{!att.label}" />
                                            </td>
                                            <td align="left">
                                            	<apex:outputPanel layout="none" rendered="{!IF(att.label == 'Default Value',true,false)}">
                                                	<apex:inputField value="{!selectedAttribute[att.fieldPath]}" styleClass="accept-expression" id="default-value" required="{!OR(att.required, att.dbrequired)}"/>
                                                </apex:outputPanel>
                                            	<apex:outputPanel layout="none" rendered="{!IF(att.Label == 'Line Item Description',true,false)}">
                                                	<apex:inputField value="{!selectedAttribute[att.fieldPath]}" styleClass="accept-expression" id="line-item-description" required="{!OR(att.required, att.dbrequired)}"/>
                                                </apex:outputPanel>
                                            	<apex:outputPanel layout="none" rendered="{!IF(att.label != 'Default Value' && att.Label != 'Line Item Description',true,false)}">
                                                	<apex:inputField value="{!selectedAttribute[att.fieldPath]}" required="{!OR(att.required, att.dbrequired)}"/>
                                                </apex:outputPanel>
                                            </td>
                                        </tr>
                                    </apex:repeat>
                                    <tr>
                                        <td colspan="2" align="center">
                                            <input type="button" value="Update Attribute" onClick="saveAttribute($(this),$(this).parent().find('#attribute-id-bottom').val());"/>
                                            <input type="hidden" class="attribute-id" id="attribute-id-bottom" value="" />
                                        </td>
                                    </tr>
                                </table>
							</fieldset>
							<fieldset class="property-inspector attribute-properties" id='attributePropertyInspector-SelectList'>
                           		<legend>Attribute Details</legend>
                                <table>
                                    <tr>
                                        <td colspan="2" align="center">
                                            <input type="button" value="Update Attribute" onClick="saveAttribute($(this),$(this).parent().find('#attribute-id').val());"/>
                                            <input type="hidden" class="attribute-id" id="attribute-id" value="" />
                                        </td>
                                    </tr>
                                    <apex:repeat value="{! $ObjectType.cscfga__Attribute_Definition__c.FieldSets['SelectListProperties']}" var="att">
                                        <tr>
                                            <td align="left" class="field-label">
                                                <apex:outputText value="{!att.label}" />
                                            </td>
                                            <td align="left">
                                            	<apex:outputPanel layout="none" rendered="{!IF(att.label == 'Default Value',true,false)}">
                                                	<apex:inputField value="{!selectedAttribute[att.fieldPath]}" styleClass="accept-expression" id="default-value" required="{!OR(att.required, att.dbrequired)}"/>
                                                </apex:outputPanel>
                                            	<apex:outputPanel layout="none" rendered="{!IF(att.Label == 'Line Item Description',true,false)}">
                                                	<apex:inputField value="{!selectedAttribute[att.fieldPath]}" styleClass="accept-expression" id="line-item-description" required="{!OR(att.required, att.dbrequired)}"/>
                                                </apex:outputPanel>
                                            	<apex:outputPanel layout="none" rendered="{!IF(att.label != 'Default Value' && att.Label != 'Line Item Description',true,false)}">
                                                	<apex:inputField value="{!selectedAttribute[att.fieldPath]}" required="{!OR(att.required, att.dbrequired)}"/>
                                                </apex:outputPanel>
                                            </td>
                                        </tr>
                                    </apex:repeat>
                                    <tr>
                                    	<td colspan="2" align="center">
                                    		<div id="SelectList-selectOptionsDiv">
                                    		</div>
                                    	</td>
                                    </tr>
                                    <tr>
                                        <td colspan="2" align="center">
                                            <input type="button" value="Update Attribute" onClick="saveAttribute($(this),$(this).parent().find('#attribute-id-bottom').val());"/>
                                            <input type="hidden" class="attribute-id" id="attribute-id-bottom" value="" />
                                        </td>
                                    </tr>
                                </table>
							</fieldset>
							<fieldset class="property-inspector attribute-properties" id='attributePropertyInspector-TextDisplay'>
                           		<legend>Attribute Details</legend>
                                <table>
                                    <tr>
                                        <td colspan="2" align="center">
                                            <input type="button" value="Update Attribute" onClick="saveAttribute($(this),$(this).parent().find('#attribute-id').val());"/>
                                            <input type="hidden" class="attribute-id" id="attribute-id" value="" />
                                        </td>
                                    </tr>
                                    <apex:repeat value="{! $ObjectType.cscfga__Attribute_Definition__c.FieldSets['TextDisplayProperties']}" var="att">
                                        <tr>
                                            <td align="left" class="field-label">
                                                <apex:outputText value="{!att.label}" />
                                            </td>
                                            <td align="left">
                                            	<apex:outputPanel layout="none" rendered="{!IF(att.label == 'Default Value',true,false)}">
                                                	<apex:inputField value="{!selectedAttribute[att.fieldPath]}" styleClass="accept-expression" id="default-value" required="{!OR(att.required, att.dbrequired)}"/>
                                                </apex:outputPanel>
                                            	<apex:outputPanel layout="none" rendered="{!IF(att.Label == 'Line Item Description',true,false)}">
                                                	<apex:inputField value="{!selectedAttribute[att.fieldPath]}" styleClass="accept-expression" id="line-item-description" required="{!OR(att.required, att.dbrequired)}"/>
                                                </apex:outputPanel>
                                            	<apex:outputPanel layout="none" rendered="{!IF(att.label != 'Default Value' && att.Label != 'Line Item Description',true,false)}">
                                                	<apex:inputField value="{!selectedAttribute[att.fieldPath]}" required="{!OR(att.required, att.dbrequired)}"/>
                                                </apex:outputPanel>
                                            </td>
                                        </tr>
                                    </apex:repeat>
                                    <tr>
                                        <td colspan="2" align="center">
                                            <input type="button" value="Update Attribute" onClick="saveAttribute($(this),$(this).parent().find('#attribute-id-bottom').val());"/>
                                            <input type="hidden" class="attribute-id" id="attribute-id-bottom" value="" />
                                        </td>
                                    </tr>
                                </table>
							</fieldset>
							<fieldset class="property-inspector attribute-properties" id='attributePropertyInspector-UserInput'>
                           		<legend>Attribute Details</legend>
                                <table>
                                    <tr>
                                        <td colspan="2" align="center">
                                            <input type="button" value="Update Attribute" onClick="saveAttribute($(this),$(this).parent().find('#attribute-id').val());"/>
                                            <input type="hidden" class="attribute-id" id="attribute-id" value="" />
                                        </td>
                                    </tr>
                                    <apex:repeat value="{! $ObjectType.cscfga__Attribute_Definition__c.FieldSets['UserInput']}" var="att">
                                        <tr>
                                            <td align="left" class="field-label">
                                                <apex:outputText value="{!att.label}" />
                                            </td>
                                            <td align="left">
                                            	<apex:outputPanel layout="none" rendered="{!IF(att.label == 'Default Value',true,false)}">
                                                	<apex:inputField value="{!selectedAttribute[att.fieldPath]}" styleClass="accept-expression" id="default-value" required="{!OR(att.required, att.dbrequired)}"/>
                                                </apex:outputPanel>
                                            	<apex:outputPanel layout="none" rendered="{!IF(att.Label == 'Line Item Description',true,false)}">
                                                	<apex:inputField value="{!selectedAttribute[att.fieldPath]}" styleClass="accept-expression" id="line-item-description" required="{!OR(att.required, att.dbrequired)}"/>
                                                </apex:outputPanel>
                                            	<apex:outputPanel layout="none" rendered="{!IF(att.label != 'Default Value' && att.Label != 'Line Item Description',true,false)}">
                                                	<apex:inputField value="{!selectedAttribute[att.fieldPath]}" required="{!OR(att.required, att.dbrequired)}"/>
                                                </apex:outputPanel>
                                            </td>
                                        </tr>
                                    </apex:repeat>
                                    <tr>
                                        <td colspan="2" align="center">
                                            <input type="button" value="Update Attribute" onClick="saveAttribute($(this),$(this).parent().find('#attribute-id-bottom').val());"/>
                                            <input type="hidden" class="attribute-id" id="attribute-id-bottom" value="" />
                                        </td>
                                    </tr>
                                </table>
							</fieldset>
                           	<fieldset class="property-inspector screen-properties" id='screenPropertyInspector'>
                           		<legend>Screen Details</legend>
                                <table>
                                    <tr>
                                        <td colspan="2" align="center">
                                            <input type="button" value="Update Screen" onClick="saveScreen($(this),$(this).parent().find('#screen-id').val());" />
                                            <input type="hidden" class="screen-id" id="screen-id" value="" />
                                        </td>
                                    </tr>
                                    <apex:repeat value="{! $ObjectType.cscfga__Configuration_Screen__c.FieldSets.ScreenFieldSet }" var="att">
                                        <tr>
                                            <td align="left" class="field-label">
                                                <apex:outputText value="{!att.label}" />
                                            </td>
                                            <td align="left">
                                                <apex:inputField value="{!selectedScreen[att.fieldPath]}" required="{!OR(att.required, att.dbrequired)}"
                                                />
                                                <br/>
                                            </td>
                                        </tr>
                                    </apex:repeat>
                                    <tr>
                                        <td colspan="2" align="center">
                                            <input type="button" value="Update Screen" onClick="saveScreen($(this),$(this).parent().find('#screen-id-bottom').val());" />
                                            <input type="hidden" class="screen-id" id="screen-id-bottom" value="" />
                                        </td>
                                    </tr>
                                </table>
                        	</fieldset>
                           	<fieldset class="property-inspector section-properties" id='sectionPropertyInspector'>
                           		<legend>Section Details</legend>
                                <table>
                                    <tr>
                                        <td colspan="2" align="center">
                                            <input type="button" value="Update Section" onClick="saveSection($(this),$(this).parent().find('#section-id').val());" />
                                            <input type="hidden" class="section-id" id="section-id" value="" />
                                        </td>
                                    </tr>
                                    <apex:repeat value="{! $ObjectType.cscfga__Screen_Section__c.FieldSets.SectionFieldSet }" var="att">
                                        <tr>
                                            <td align="left" class="field-label">
                                                <apex:outputText value="{!att.label}" />
                                            </td>
                                            <td align="left">
                                                <apex:inputField value="{!selectedSection[att.fieldPath]}" required="{!OR(att.required, att.dbrequired)}"
                                                />
                                                <br/>
                                            </td>
                                        </tr>
                                    </apex:repeat>
                                    <tr>
                                        <td colspan="2" align="center">
                                            <input type="button" value="Update Section" onClick="saveSection($(this),$(this).parent().find('#section-id-bottom').val());" />
                                            <input type="hidden" class="section-id" id="section-id-bottom" value="" />
                                        </td>
                                    </tr>
                                </table>
                        	</fieldset>
                           	<fieldset class="property-inspector screen-sort-properties" id="screenSortProperties">
                           		<legend>Re-order screens and sections</legend>
                                <table>
                                    <tr>
                                        <td colspan="2" align="center">
                                            <select id="screenSort" onChange="displaySortScreen($(this).val(),'{!cscfga__Product_Definition__c.Id}');">
                                            	<option value="Sort" selected="true">Select Components To Sort</option>
                                            	<option value="Screens">Order Screens &amp; Sections</option>
                                            	<option value="Attributes">Order Calculation Attributes</option>
                                            </select>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td colspan="2" align="center">
                                            <input type="button" value="Save Sort Order" onClick="screenSaveSort()" class="btn"/>
                                        </td>
                                    </tr>
                                    <tr>
                                    	<td>
                                    		<ul class="Screen-Select-Sort">
					                    	</ul>
                                    	</td>
                                    </tr>
                                    <tr>
                                        <td colspan="2" align="center">
                                            <input type="button" value="Save Sort Order" onClick="screenSaveSort()"  class="btn"/>
                                        </td>
                                    </tr>
                                </table>
                        	</fieldset>
                           	<fieldset class="property-inspector attribute-sort-properties" id="attributeSortProperties">
                           		<legend>Re-order calculation attributes</legend>
                                <table>
                                    <tr>
                                        <td colspan="2" align="center">
                                            <select id="attributeSort" onChange="displaySortScreen($(this).val(),'{!cscfga__Product_Definition__c.Id}');">
                                            	<option value="Sort" selected="true">Select Components To Sort</option>
                                            	<option value="Screens">Order Screens &amp; Sections</option>
                                            	<option value="Attributes">Order Calculation Attributes</option>
                                            </select>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td colspan="2" align="center">
                                            <input type="text" id="baseSequence" size="3" maxlength="3" value=""/>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td colspan="2" align="center">
                                            <input type="button" value="Save Sort Order" onClick="calcAttributeSaveSort()" class="btn"/>
                                        </td>
                                    </tr>
                                    <tr>
                                    	<td>
                                    		<ul class="CalcAttribute-Select-Sort">
					                    	</ul>
                                    	</td>
                                    </tr>
                                    <tr>
                                        <td colspan="2" align="center">
                                            <input type="button" value="Save Sort Order" onClick="calcAttributeSaveSort()"  class="btn"/>
                                        </td>
                                    </tr>
                                </table>
                        	</fieldset>
                           	<fieldset class="property-inspector rule-properties" id='rulePropertyInspectorId'>
                           		<legend>Rule Details</legend>
                                <table>
                                    <tr>
                                        <td colspan="2" align="center">
                                            <input type="button" value="Update Rule" onClick="saveRule($(this),$(this).parent().find('#rule-id').val());" />
                                            <input type="hidden" class="rule-id" id="rule-id" value="" />
                                        </td>
                                    </tr>
                                    <apex:repeat value="{! $ObjectType.cscfga__Rule__c.FieldSets.RuleFieldSet }" var="att">
                                        <tr>
                                            <td align="left" class="field-label">
                                                <apex:outputText value="{!att.label}" />
                                            </td>
                                            <td align="left">
                                                <apex:inputField value="{!selectedRule[att.fieldPath]}" required="{!OR(att.required, att.dbrequired)}"/>
                                                <br/>
                                            </td>
                                        </tr>
                                    </apex:repeat>
                                    <tr>
                                        <td colspan="2" align="center">
                                            <input type="button" value="Update Rule" onClick="saveRule($(this),$(this).parent().find('#rule-id-bottom').val());" />
                                            <input type="hidden" class="rule-id" id="rule-id-bottom" value="" />
                                        </td>
                                    </tr>
                                </table>
                        	</fieldset>
                           	<fieldset class="property-inspector predicate-properties" id='predicatePropertyInspector-attribute'>
                           		<legend>Predicate Details</legend>
                                <table>
                                    <tr>
                                        <td colspan="2" align="center">
                                            <input type="button" value="Update Predicate" onClick="savePredicate($(this),$(this).parent().find('#predicate-id').val());" />
                                            <input type="hidden" class="predicate-id" id="predicate-id" value="" />
                                        </td>
                                    </tr>
                                    <apex:repeat value="{! $ObjectType.cscfga__Predicate__c.FieldSets.PredicateAttribute}" var="att">
                                        <tr>
                                            <td align="left" class="field-label">
                                                <apex:outputText value="{!att.label}" />
                                            </td>
                                            <td align="left">
                                            	<apex:outputPanel rendered="{!IF(att.label=='Value',true,false)}">
                                                	<apex:inputField styleClass="accept-expression" value="{!selectedPredicate[att.fieldPath]}" required="{!OR(att.required, att.dbrequired)}"/>
                                                </apex:outputPanel>
                                            	<apex:outputPanel rendered="{!IF(att.label!='Value',true,false)}">
                                                	<apex:inputField value="{!selectedPredicate[att.fieldPath]}" required="{!OR(att.required, att.dbrequired)}"/>
                                                </apex:outputPanel>
                                            </td>
                                        </tr>
                                    </apex:repeat>
                                    <tr>
                                        <td colspan="2" align="center">
                                            <input type="button" value="Update Predicate" onClick="savePredicate($(this),$(this).parent().find('#predicate-id-bottom').val());" />
                                            <input type="hidden" class="predicate-id" id="predicate-id-bottom" value="" />
                                        </td>
                                    </tr>
                                </table>
                        	</fieldset>
                           	<fieldset class="property-inspector predicate-properties" id='predicatePropertyInspector-product'>
                           		<legend>Predicate Details</legend>
                                <table>
                                    <tr>
                                        <td colspan="2" align="center">
                                            <input type="button" value="Update Predicate" onClick="savePredicate($(this),$(this).parent().find('#predicate-id').val());" />
                                            <input type="hidden" class="predicate-id" id="predicate-id" value="" />
                                        </td>
                                    </tr>
                                    <apex:repeat value="{! $ObjectType.cscfga__Predicate__c.FieldSets.PredicateProduct}" var="att">
                                        <tr>
                                            <td align="left" class="field-label">
                                                <apex:outputText value="{!att.label}" />
                                            </td>
                                            <td align="left">
                                            	<apex:outputPanel rendered="{!IF(att.label=='Value',true,false)}">
                                                	<apex:inputField styleClass="accept-expression" value="{!selectedPredicate[att.fieldPath]}" required="{!OR(att.required, att.dbrequired)}"/>
                                                </apex:outputPanel>
                                            	<apex:outputPanel rendered="{!IF(att.label!='Value',true,false)}">
                                                	<apex:inputField value="{!selectedPredicate[att.fieldPath]}" required="{!OR(att.required, att.dbrequired)}"/>
                                                </apex:outputPanel>
                                            </td>
                                        </tr>
                                    </apex:repeat>
                                    <tr>
                                        <td colspan="2" align="center">
                                            <input type="button" value="Update Predicate" onClick="savePredicate($(this),$(this).parent().find('#predicate-id-bottom').val());" />
                                            <input type="hidden" class="predicate-id" id="predicate-id-bottom" value="" />
                                        </td>
                                    </tr>
                                </table>
                        	</fieldset>
                           	<fieldset class="property-inspector action-properties" id='actionPropertyInspector-ConstrainValues'>
                           		<legend>Action Details</legend>
                                <table>
                                    <tr>
                                        <td colspan="2" align="center">
                                            <input type="button" value="Update Action" onClick="saveAction($(this),$(this).parent().find('#action-id').val());" />
                                            <input type="hidden" class="action-id" id="action-id" value="" />
                                        </td>
                                    </tr>
                                    <apex:repeat value="{! $ObjectType.cscfga__Action__c.FieldSets.ConstrainValues}" var="att">
                                        <tr>
                                            <td align="left" class="field-label">
                                                <apex:outputText value="{!att.label}" />
                                            </td>
                                            <td align="left">
                                            	<apex:outputPanel rendered="{!IF(att.label=='Value',true,false)}">
                                                	<apex:inputField styleClass="accept-expression" value="{!selectedAction[att.fieldPath]}" required="{!OR(att.required, att.dbrequired)}"/>
                                                </apex:outputPanel>
                                            	<apex:outputPanel rendered="{!IF(att.label!='Value',true,false)}">
                                                	<apex:inputField value="{!selectedAction[att.fieldPath]}" required="{!OR(att.required, att.dbrequired)}"/>
                                                </apex:outputPanel>
                                            </td>
                                        </tr>
                                    </apex:repeat>
                                    <tr>
                                    	<td><div style="min-height: 30px;"></div></td>
                                       	<td><div style="min-height: 30px;"></div></td>
                                    </tr>
                                    <tr>
                                        <td colspan="2" style="min-width:250px;">
                                        	<Div id="multi-select-div">
                                           		
                                           	</div>
                                        </td>
                                   	</tr>
                                    <tr>
                                        <td colspan="2" align="center">
                                            <input type="button" value="Update Action" onClick="saveAction($(this),$(this).parent().find('#action-id-bottom').val());" />
                                            <input type="hidden" class="action-id" id="action-id-bottom" value="" />
                                        </td>
                                    </tr>
                                </table>
                        	</fieldset>
                           	<fieldset class="property-inspector action-properties" id='actionPropertyInspector-Javascript'>
                           		<legend>Action Details</legend>
                                <table>
                                    <tr>
                                        <td colspan="2" align="center">
                                            <input type="button" value="Update Action" onClick="saveAction($(this),$(this).parent().find('#action-id').val());" />
                                            <input type="hidden" class="action-id" id="action-id" value="" />
                                        </td>
                                    </tr>
                                    <apex:repeat value="{! $ObjectType.cscfga__Action__c.FieldSets.Javascript}" var="att">
                                        <tr>
                                            <td align="left" class="field-label">
                                                <apex:outputText value="{!att.label}" />
                                            </td>
                                            <td align="left">
                                            	<apex:outputPanel rendered="{!IF(att.label=='Value',true,false)}">
                                                	<apex:inputField styleClass="accept-expression" value="{!selectedAction[att.fieldPath]}" required="{!OR(att.required, att.dbrequired)}"/>
                                                </apex:outputPanel>
                                            	<apex:outputPanel rendered="{!IF(att.label!='Value',true,false)}">
                                                	<apex:inputField value="{!selectedAction[att.fieldPath]}" required="{!OR(att.required, att.dbrequired)}"/>
                                                </apex:outputPanel>
                                            </td>
                                        </tr>
                                    </apex:repeat>
                                    <tr>
                                        <td colspan="2" align="center">
                                            <input type="button" value="Update Action" onClick="saveAction($(this),$(this).parent().find('#action-id-bottom').val());" />
                                            <input type="hidden" class="action-id" id="action-id-bottom" value="" />
                                        </td>
                                    </tr>
                                </table>
                        	</fieldset>
                           	<fieldset class="property-inspector action-properties" id='actionPropertyInspector-SetAttributeField'>
                           		<legend>Action Details</legend>
                                <table>
                                    <tr>
                                        <td colspan="2" align="center">
                                            <input type="button" value="Update Action" onClick="saveAction($(this),$(this).parent().find('#action-id').val());" />
                                            <input type="hidden" class="action-id" id="action-id" value="" />
                                        </td>
                                    </tr>
                                    <apex:repeat value="{! $ObjectType.cscfga__Action__c.FieldSets.SetAttributeField}" var="att">
                                        <tr>
                                            <td align="left" class="field-label">
                                                <apex:outputText value="{!att.label}" />
                                            </td>
                                            <td align="left">
                                            	<apex:outputPanel rendered="{!IF(att.label=='Value',true,false)}">
                                                	<apex:inputField styleClass="accept-expression" value="{!selectedAction[att.fieldPath]}" required="{!OR(att.required, att.dbrequired)}"/>
                                                </apex:outputPanel>
                                            	<apex:outputPanel rendered="{!IF(att.label!='Value',true,false)}">
                                                	<apex:inputField value="{!selectedAction[att.fieldPath]}" required="{!OR(att.required, att.dbrequired)}"/>
                                                </apex:outputPanel>
                                            </td>
                                        </tr>
                                    </apex:repeat>
                                    <tr>
                                        <td colspan="2" align="center">
                                            <input type="button" value="Update Action" onClick="saveAction($(this),$(this).parent().find('#action-id-bottom').val());" />
                                            <input type="hidden" class="action-id" id="action-id-bottom" value="" />
                                        </td>
                                    </tr>
                                </table>
                        	</fieldset>
                           	<fieldset class="property-inspector action-properties" id='actionPropertyInspector-SetField'>
                           		<legend>Action Details</legend>
                                <table>
                                    <tr>
                                        <td colspan="2" align="center">
                                            <input type="button" value="Update Action" onClick="saveAction($(this),$(this).parent().find('#action-id').val());" />
                                            <input type="hidden" class="action-id" id="action-id" value="" />
                                        </td>
                                    </tr>
                                    <apex:repeat value="{! $ObjectType.cscfga__Action__c.FieldSets.SetField}" var="att">
                                        <tr>
                                            <td align="left" class="field-label">
                                                <apex:outputText value="{!att.label}" />
                                            </td>
                                            <td align="left">
                                            	<apex:outputPanel rendered="{!IF(att.label=='Value',true,false)}">
                                                	<apex:inputField styleClass="accept-expression" value="{!selectedAction[att.fieldPath]}" required="{!OR(att.required, att.dbrequired)}"/>
                                                </apex:outputPanel>
                                            	<apex:outputPanel rendered="{!IF(att.label!='Value',true,false)}">
                                                	<apex:inputField value="{!selectedAction[att.fieldPath]}" required="{!OR(att.required, att.dbrequired)}"/>
                                                </apex:outputPanel>
                                            </td>
                                        </tr>
                                    </apex:repeat>
                                    <tr>
                                        <td colspan="2" align="center">
                                            <input type="button" value="Update Action" onClick="saveAction($(this),$(this).parent().find('#action-id-bottom').val());" />
                                            <input type="hidden" class="action-id" id="action-id-bottom" value="" />
                                        </td>
                                    </tr>
                                </table>
                        	</fieldset>
                           	<fieldset class="property-inspector action-properties" id='actionPropertyInspector-SetFieldProduct'>
                           		<legend>Action Details</legend>
                                <table>
                                    <tr>
                                        <td colspan="2" align="center">
                                            <input type="button" value="Update Action" onClick="saveAction($(this),$(this).parent().find('#action-id').val());" />
                                            <input type="hidden" class="action-id" id="action-id" value="" />
                                        </td>
                                    </tr>
                                    <apex:repeat value="{! $ObjectType.cscfga__Action__c.FieldSets.SetFieldProduct}" var="att">
                                        <tr>
                                            <td align="left" class="field-label">
                                                <apex:outputText value="{!att.label}" />
                                            </td>
                                            <td align="left">
                                            	<apex:outputPanel rendered="{!IF(att.label=='Value',true,false)}">
                                                	<apex:inputField styleClass="accept-expression" value="{!selectedAction[att.fieldPath]}" required="{!OR(att.required, att.dbrequired)}"/>
                                                </apex:outputPanel>
                                            	<apex:outputPanel rendered="{!IF(att.label!='Value',true,false)}">
                                                	<apex:inputField value="{!selectedAction[att.fieldPath]}" required="{!OR(att.required, att.dbrequired)}"/>
                                                </apex:outputPanel>
                                            </td>
                                        </tr>
                                    </apex:repeat>
                                    <tr>
                                        <td colspan="2" align="center">
                                            <input type="button" value="Update Action" onClick="saveAction($(this),$(this).parent().find('#action-id-bottom').val());" />
                                            <input type="hidden" class="action-id" id="action-id-bottom" value="" />
                                        </td>
                                    </tr>
                                </table>
                        	</fieldset>
                        </div>
                    </td>
                </tr>
            </table>
    </apex:form>
</apex:page>